<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>ğŸ‘¾ Invasores de la FÃ­sica ğŸš€ (Visualmente Mejorado)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

    <style>
        /* --- Variables de Color CSS (Paleta Ajustada) --- */
        :root {
            --bg-dark: #18181b; /* zinc-900 */
            --container-bg: #27272a; /* zinc-800 */
            --ui-bar-bg: #1f1f23; /* Un poco mÃ¡s oscuro para la barra de UI */
            --modal-bg: #2a2a2e; /* Ligeramente mÃ¡s claro para modales */
            --canvas-bg: #000000; /* Fondo negro para el juego */

            --text-light: #f4f4f5; /* zinc-100 */
            --text-muted: #a1a1aa; /* zinc-400 */
            --accent-green: #39ff14; /* Verde neÃ³n */
            --accent-blue: #00ffff; /* Cyan neÃ³n */
            --accent-pink: #ff00ff; /* Magenta neÃ³n */
            --accent-red: #ff1f1f; /* Rojo neÃ³n */
            --accent-yellow: #ffff00; /* Amarillo neÃ³n */
            --border-color: #52525b; /* zinc-600 */
            --control-bg: #3f3f46; /* zinc-700 */
            --control-hover-bg: #52525b; /* zinc-600 */
            --button-secondary-bg: #52525b; /* zinc-600 */
            --button-secondary-hover-bg: #71717a; /* zinc-500 */
            --global-btn-bg: #3f3f46; /* zinc-700 */
            --global-btn-hover-bg: #52525b; /* zinc-600 */
            --paused-overlay-bg: rgba(10, 10, 10, 0.7);

            /* Colores especÃ­ficos para balas/items */
            --player-bullet-color: var(--accent-green);
            --invader-bullet-color: var(--accent-red);
            --item-life-color: var(--accent-green);
            --item-bomb-color: var(--accent-red);
            --item-score-color: var(--accent-yellow);
            --item-question-color: var(--accent-blue);
            --item-fastshoot-color: var(--accent-pink);
            --item-shield-color: var(--accent-blue);
            --hit-flash-color: #ffffff;

            /* Nuevos colores para progreso y estrellas */
            --progress-bar-bg: #333;
            --progress-bar-fill: var(--accent-green);
            --star-filled-color: var(--accent-yellow);
            --star-empty-color: var(--text-muted);

            /* âœ¨ Nueva Fuente Principal y de Respaldo âœ¨ */
            --font-primary: 'Nunito', sans-serif;
            --font-pixel: 'Press Start 2P', cursive;
        }

        /* Estilos generales */
        body {
            background-color: var(--bg-dark);
            color: var(--text-light);
            font-family: var(--font-primary); /* âœ¨ Usando nueva fuente primaria âœ¨ */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 0.5rem;
            overflow-x: hidden; /* Evitar scroll horizontal innecesario */
            touch-action: manipulation;
            image-rendering: pixelated; /* Mantenemos esto para el canvas */
        }
        .container {
            width: 100%;
            max-width: 750px;
            margin: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            border: 3px solid var(--accent-blue);
            border-radius: 10px;
            background-color: var(--container-bg);
            padding: 1rem; /* Ligeramente reducido para dar mÃ¡s espacio */
            box-shadow: 0 0 25px var(--accent-blue), inset 0 0 10px rgba(0, 255, 255, 0.3);
        }

        /* Controles Globales */
        #global-controls { display: flex; justify-content: center; gap: 0.8rem; width: 100%; max-width: 700px; margin-bottom: 0.8rem; }
        .global-btn {
            background-color: var(--global-btn-bg);
            color: var(--text-light);
            border: 2px solid var(--border-color);
            border-radius: 5px;
            padding: 0.4rem 0.8rem; /* ğŸ“ Reducido para mÃ³viles */
            font-size: 0.7rem; /* ğŸ“ Reducido para mÃ³viles */
            font-family: var(--font-primary); /* âœ¨ Fuente actualizada âœ¨ */
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.15s, transform 0.1s, box-shadow 0.15s;
            box-shadow: 2px 2px 0px var(--border-color);
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        .global-btn:hover:not(:disabled) { background-color: var(--global-btn-hover-bg); box-shadow: 2px 2px 5px var(--accent-blue); }
        .global-btn:active:not(:disabled) { transform: translate(1px, 1px); box-shadow: 1px 1px 0px var(--border-color); }
        .global-btn:disabled { opacity: 0.6; cursor: not-allowed; background-color: var(--control-bg); box-shadow: 1px 1px 0px #111; transform: translate(1px, 1px); }

        /* Mensaje de Pausa */
        #pause-message {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background-color: var(--paused-overlay-bg); color: var(--accent-yellow);
            padding: 1.8rem 2.2rem; border-radius: 10px;
            font-size: 1.5rem; /* ğŸ“ Reducido ligeramente */
            text-align: center; z-index: 1005; display: none;
            border: 3px solid var(--accent-yellow); box-shadow: 0 0 15px var(--accent-yellow);
            text-shadow: 0 0 5px #000;
            font-family: var(--font-pixel); /* âœ¨ Fuente pixel para el mensaje de pausa âœ¨ */
        }

        /* Canvas del Juego */
        #gameCanvas { background-color: var(--canvas-bg); display: block; width: 100%; max-width: 700px; height: auto; aspect-ratio: 4 / 3; border: 3px solid var(--accent-pink); border-radius: 6px; margin-bottom: 1rem; position: relative; cursor: none; box-shadow: 0 0 10px var(--accent-pink); }

        /* Barra de UI (EstadÃ­sticas) */
        #ui-bar { display: flex; justify-content: space-around; align-items: center; width: 100%; max-width: 700px; padding: 0.5rem 0.8rem; background-color: var(--ui-bar-bg); border: 2px solid var(--border-color); border-radius: 6px; margin-bottom: 1rem; font-size: 0.65rem; text-transform: uppercase; gap: 0.4rem; flex-wrap: wrap; box-shadow: inset 0 0 5px rgba(0,0,0,0.5); font-weight: 700; }
        .stat { display: flex; align-items: center; gap: 0.3rem; padding: 0.2rem 0.4rem; background-color: rgba(255,255,255,0.05); border-radius: 4px;}
        .stat span { color: var(--accent-yellow); margin-left: 0.3rem; font-weight: bold; }
        #lives span { color: var(--accent-green); }
        #level span { color: var(--accent-pink); }
        #questions-answered-ui { color: var(--accent-blue) !important; }
        #questions-target-ui { color: var(--accent-blue) !important; }
        #questions-remaining-ui { color: var(--accent-yellow) !important; }

        /* Barra de Progreso Preguntas */
        #question-progress-bar-container { width: 100%; background-color: var(--progress-bar-bg); border-radius: 4px; height: 10px; margin-top: 0.3rem; border: 1px solid var(--border-color); overflow: hidden; }
        #question-progress-bar { width: 0%; height: 100%; background-color: var(--progress-bar-fill); transition: width 0.3s ease-in-out; }
        .stat-questions { flex-basis: 100%; text-align: center; margin-top: 0.5rem;}

        /* Controles TÃ¡ctiles */
        #mobile-controls { display: none; justify-content: space-between; align-items: center; width: 95%; max-width: 500px; margin-top: 0.8rem; gap: 0.8rem; } /* ğŸ“ Max-width reducido */
        .control-btn {
            background-color: var(--control-bg); color: var(--text-light);
            border: 2px solid var(--border-color); border-radius: 50%;
            width: 55px; height: 55px; font-size: 1.8rem; /* ğŸ“ TamaÃ±o y fuente reducidos */
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: 3px 3px 0px var(--border-color);
            transition: background-color 0.1s, transform 0.1s, box-shadow 0.1s;
            user-select: none; -webkit-tap-highlight-color: transparent;
            font-family: 'Arial', sans-serif; /* Mantener fuente clara para Ã­conos */
        }
        .control-btn.active-touch { background-color: var(--control-hover-bg); transform: translate(2px, 2px); box-shadow: 1px 1px 0px var(--border-color); }
        #shoot-btn {
            background-color: var(--accent-red); color: var(--bg-dark);
            width: 70px; height: 70px; border-color: #ff5555; /* ğŸ“ TamaÃ±o reducido */
            box-shadow: 4px 4px 0px #aa0000; font-size: 2.2rem; /* ğŸ“ Fuente reducida */
        }
        #shoot-btn.active-touch { background-color: #cc0000; box-shadow: 2px 2px 0px #aa0000; transform: translate(2px, 2px); }

        /* Modales */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(10, 10, 10, 0.85); display: none; align-items: center; justify-content: center; z-index: 1010; padding: 1rem; font-family: var(--font-primary); backdrop-filter: blur(3px); } /* âœ¨ Fuente actualizada âœ¨ */
        .modal-overlay.visible { display: flex; animation: fadeInModal 0.3s ease-out; }
        @keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }
        .modal-content { background-color: var(--modal-bg); padding: 1.5rem 1.8rem; border-radius: 8px; width: 95%; max-width: 550px; box-shadow: 0 0 25px rgba(0, 0, 0, 0.6); color: var(--text-light); border: 3px solid var(--border-color); text-align: center; animation: slideInModal 0.3s ease-out; max-height: 85vh; overflow-y: auto;} /* ğŸ“œ Habilitado scroll para modales */

        @keyframes slideInModal { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .modal-title { font-size: 1.3rem; color: var(--accent-yellow); margin-bottom: 1.5rem; text-transform: uppercase; text-shadow: 1px 1px 3px #000; font-weight: 800; } /* ğŸ“ Fuente reducida, peso aumentado */
        .modal-body p { margin-bottom: 1rem; line-height: 1.6; font-size: 0.8rem; text-align: left; } /* ğŸ“ Fuente y margen ajustados */
        .modal-body ul { list-style: disc; padding-left: 1.2rem; margin-bottom: 1rem; text-align: left; } /* Usar 'disc' para listas */
        .modal-body li { margin-bottom: 0.5rem; font-size: 0.8rem; } /* ğŸ“ Fuente ajustada */
        .modal-body li strong { color: var(--accent-yellow); margin-right: 0.3rem; font-weight: 700;}

        /* Estrellas de CalificaciÃ³n */
        .rating-stars { font-size: 1.3rem; margin-bottom: 0.4rem; } /* ğŸ“ Reducido */
        .rating-stars .star-filled { color: var(--star-filled-color); }
        .rating-stars .star-empty { color: var(--star-empty-color); }

        .final-screen .stat-final { font-size: 0.8rem; margin-bottom: 0.7rem; text-align: left; color: var(--text-muted); } /* ğŸ“ Reducido */
        .final-screen .stat-final strong { color: var(--text-light); margin-left: 0.4rem; font-weight: 700; }
        .final-screen #high-score-display, .final-screen #high-score-display-complete { margin-top: 1rem; font-size: 0.75rem; color: var(--accent-blue); text-align: center; } /* ğŸ“ Reducido */
        .final-screen #fact-display, .final-screen #fact-display-complete { margin-top: 1rem; font-size: 0.7rem; color: var(--accent-pink); font-style: italic; text-align: left; line-height: 1.4; padding: 0.4rem; background-color: rgba(255,0,255,0.05); border-left: 3px solid var(--accent-pink); border-radius: 4px;} /* ğŸ“ Reducido */
        .final-screen .play-again-button, .final-screen #next-level-button { margin-top: 1.5rem; } /* ğŸ“ Reducido */

        .modal-body button, .difficulty-btn, #start-button, #help-button, #close-help-button {
            background-color: var(--control-bg); color: var(--text-light);
            border: 2px solid var(--border-color); border-radius: 5px;
            padding: 0.6rem 1rem; font-size: 0.8rem; /* ğŸ“ Reducido */
            cursor: pointer; box-shadow: 2px 2px 0px var(--border-color);
            transition: background-color 0.15s, transform 0.1s, box-shadow 0.15s;
            text-transform: uppercase; margin: 0.4rem 0.2rem;
            font-family: var(--font-primary); /* âœ¨ Fuente actualizada âœ¨ */
            font-weight: 700;
        }
        .modal-body button:hover, .difficulty-btn:hover, #start-button:hover, #help-button:hover, #close-help-button:hover { background-color: var(--control-hover-bg); box-shadow: 2px 2px 5px var(--accent-blue); }
        .modal-body button:active, .difficulty-btn:active, #start-button:active, #help-button:active, #close-help-button:active { transform: translate(1px, 1px); box-shadow: 1px 1px 0px var(--border-color); }

        button.option-btn { display: block; width: 100%; text-align: left; margin-bottom: 0.5rem; background-color: var(--accent-blue) !important; color: var(--bg-dark) !important; border-color: #00aaaa !important; box-shadow: 2px 2px 0px #008888 !important; padding: 0.7rem 0.9rem; font-size: 0.75rem; font-weight: 700;} /* ğŸ“ Reducido */
        button.option-btn:hover { background-color: #00dddd !important; }
        button.option-btn:active { box-shadow: 1px 1px 0px #008888 !important; transform: translate(1px,1px); }
        button.option-btn:disabled { background-color: var(--border-color) !important; color: #888 !important; opacity: 0.7; cursor: not-allowed; border-color: #222 !important; box-shadow: 1px 1px 0px #222 !important; transform: translate(1px, 1px); }
        button.option-btn.correct-option { background-color: var(--accent-green) !important; border-color: #29cc04 !important; box-shadow: 1px 1px 0px #199904 !important; color: var(--bg-dark) !important; }
        button.option-btn.incorrect-option { background-color: var(--accent-red) !important; border-color: #cc0000 !important; box-shadow: 1px 1px 0px #aa0000 !important; color: var(--bg-dark) !important; }

        .feedback { margin-top: 1.2rem; padding: 0.8rem; border-radius: 6px; font-size: 0.75rem; text-align: left; border: 2px solid; } /* ğŸ“ Reducido */
        .feedback.correct { border-color: var(--accent-green); background-color: rgba(57, 255, 20, 0.15); box-shadow: 0 0 10px rgba(57, 255, 20, 0.3); }
        .feedback.incorrect { border-color: var(--accent-red); background-color: rgba(255, 31, 31, 0.15); box-shadow: 0 0 10px rgba(255, 31, 31, 0.3); }
        .feedback strong { display: block; margin-bottom: 0.4rem; font-size: 0.9rem; text-transform: uppercase; font-weight: 700; } /* ğŸ“ Reducido */
        .feedback .correct-answer-label { color: var(--accent-yellow); font-weight: bold; }
        .feedback .explanation-text { margin-top: 0.6rem; font-size: 0.7rem; color: #ddd; line-height: 1.4; } /* ğŸ“ Reducido */
        #accept-feedback-btn { background-color: var(--accent-yellow) !important; color: var(--bg-dark) !important; border-color: #cccc00 !important; box-shadow: 2px 2px 0px #aaaa00 !important; margin-top: 0.8rem; } /* ğŸ“ Reducido */
        #accept-feedback-btn:hover { background-color: #dddd00 !important; }
        #accept-feedback-btn:active { box-shadow: 1px 1px 0px #aaaa00 !important; transform: translate(1px, 1px); }

        /* Modal Specific Borders/Shadows */
        #question-modal .modal-content { border-color: var(--accent-blue); box-shadow: 0 0 20px var(--accent-blue); }
        #game-over-modal .modal-content { border-color: var(--accent-red); box-shadow: 0 0 20px var(--accent-red); }
        #level-complete-modal .modal-content { border-color: var(--accent-green); box-shadow: 0 0 20px var(--accent-green); }
        #help-modal .modal-content { border-color: var(--accent-yellow); box-shadow: 0 0 20px var(--accent-yellow); }
        #help-modal .modal-title { color: var(--accent-yellow); }
        #close-help-button { background-color: var(--accent-yellow); color: var(--bg-dark); border-color: #cccc00; box-shadow: 2px 2px 0px #aaaa00;}
        #close-help-button:hover { background-color: #dddd00; }
        #close-help-button:active { box-shadow: 1px 1px 0px #aaaa00; transform: translate(1px, 1px); }
        #restart-button-complete { background-color: var(--button-secondary-bg) !important; border-color: var(--button-secondary-hover-bg) !important; box-shadow: 2px 2px 0px var(--button-secondary-hover-bg) !important; }
        #restart-button-complete:hover { background-color: var(--button-secondary-hover-bg) !important; }

        /* Pantalla de Inicio y SelecciÃ³n de Dificultad - ğŸ¨ ESTILOS MEJORADOS PARA MÃ“VIL ğŸ“± */
        #start-screen {
            text-align: center;
            background: linear-gradient(145deg, #3a3a4a, #1e1e2f);
            padding: 1.2rem; /* ğŸ“ Reducido para mÃ³viles */
            border-radius: 10px;
            border: 3px solid var(--accent-green);
            box-shadow: inset 0 0 15px rgba(57, 255, 20, 0.3), 0 5px 10px rgba(0,0,0,0.5);
            width: 95%; /* ğŸ“ Ancho ajustado para mÃ³viles */
            max-width: 600px; /* ğŸ“ Max-width ligeramente reducido */
            display: flex;
            flex-direction: column;
            align-items: center;
            max-height: 90vh; /* ğŸ“œ Permitir scroll si el contenido es muy alto en pantallas pequeÃ±as */
            overflow-y: auto;  /* ğŸ“œ Habilitar scroll vertical si es necesario */
        }
        #start-screen h1 { /* TÃ­tulo del juego */
            font-family: var(--font-pixel); /* âœ¨ Fuente Pixel para el tÃ­tulo principal âœ¨ */
            font-size: 1.8rem; /* ğŸ“ Ligeramente mÃ¡s grande para impacto, pero responsive */
            color: var(--accent-green);
            text-shadow: 0 0 8px var(--accent-green), 0 0 15px var(--accent-green);
            border-bottom: 3px dashed var(--accent-green);
            padding-bottom: 0.6rem; /* ğŸ“ Reducido */
            margin-bottom: 1rem; /* ğŸ“ Reducido */
            width: 100%;
        }
        #start-screen p.intro-text {
            font-size: 0.85rem; /* ğŸ“ Ligeramente mÃ¡s grande para legibilidad con Nunito */
            color: #ddd;
            margin-bottom: 1rem; /* ğŸ“ Reducido */
            line-height: 1.6; /* Ligeramente aumentado para Nunito */
            max-width: 480px;
        }
        #difficulty-selection {
            margin: 1.2rem 0; /* ğŸ“ Reducido */
            width: 100%;
        }
        #difficulty-selection label {
            font-size: 0.95rem; /* ğŸ“ Ligeramente mÃ¡s grande */
            color: var(--accent-yellow);
            margin-bottom: 0.7rem; /* ğŸ“ Reducido */
            display: block;
            text-shadow: 1px 1px 2px #000;
            font-weight: 700;
        }
        #difficulty-selection .difficulty-options {
            display: flex;
            justify-content: center;
            gap: 0.6rem; /* ğŸ“ Reducido */
            flex-wrap: wrap;
        }
        .difficulty-btn {
            flex-grow: 1;
            min-width: 110px; /* ğŸ“ Reducido */
            padding: 0.5rem 0.8rem; /* ğŸ“ Reducido */
            font-size: 0.7rem; /* ğŸ“ Reducido */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.3rem; /* ğŸ“ Reducido */
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            font-weight: 700;
        }
        .difficulty-btn .difficulty-icon { font-size: 1.3rem; margin-bottom: 0.1rem; } /* ğŸ“ Icono ajustado */
        .difficulty-btn.selected { background-color: var(--accent-blue); color: var(--bg-dark); border-color: #0088cc; box-shadow: 0 0 10px var(--accent-blue), inset 0 0 5px rgba(0,0,0,0.3); transform: scale(1.05); }
        .difficulty-btn:not(.selected):hover { transform: translateY(-3px); box-shadow: 0 3px 8px rgba(0,0,0,0.4); }

        .start-actions-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.8rem; /* ğŸ“ Espacio reducido */
            margin-top: 1.2rem; /* ğŸ“ Reducido */
            width: 100%;
            flex-wrap: wrap; /* Para que los botones se ajusten en pantallas muy pequeÃ±as */
        }

        #start-button, #help-button {
            font-size: 0.8rem; /* ğŸ“ Reducido */
            padding: 0.6rem 1.2rem; /* ğŸ“ Reducido */
            margin-top: 0;
            font-weight: 700;
            flex-basis: 150px; /* Ancho base para botones */
            flex-grow: 1;
            max-width: 180px; /* Evitar que se estiren demasiado */
        }
        #start-button { background-color: var(--accent-green); color: var(--bg-dark); border-color: #29cc04; box-shadow: 3px 3px 0px #199904; }
        #start-button:hover { background-color: #2fdd0f; }
        #start-button:active { box-shadow: 1px 1px 0px #199904; transform: translate(2px, 2px); }

        #help-button { background-color: var(--accent-blue); color: var(--bg-dark); border-color: #00aaaa; box-shadow: 2px 2px 0px #008888; }
        #help-button:hover { background-color: #00cccc; }
        #help-button:active { box-shadow: 1px 1px 0px #008888; transform: translate(1px, 1px); }

        .start-screen-hint {
            font-size: 0.65rem; /* ğŸ“ Reducido */
            color: var(--text-muted);
            margin-top: 0.8rem; /* ğŸ“ Reducido */
        }


        /* Footer */
        footer { margin-top: 1.5rem; font-size: 0.7rem; text-align: center; font-style: italic; padding: 0.8rem; color: #fff; background: linear-gradient(270deg, var(--accent-blue), var(--accent-pink), var(--accent-yellow), var(--accent-green), var(--accent-blue)); background-size: 800% 800%; border-radius: 8px; animation: gradientShift 12s ease infinite; box-shadow: 0 0 20px rgba(0, 255, 255, 0.6); width: 95%; max-width: 700px;} /* ğŸ“ Ajustado para ser consistente */

        @keyframes gradientShift { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        /* Media Queries para Responsividad ğŸ“± */
        @media (max-width: 768px) { /* Ajustes generales para tablets y mÃ³viles grandes */
            .container { padding: 0.7rem; border-width: 2px; }
            #ui-bar { font-size: 0.6rem; padding: 0.4rem; gap: 0.2rem; }
            .stat {padding: 0.1rem 0.2rem;}

            /* Ajustes especÃ­ficos de Start Screen para tablets */
            #start-screen { padding: 1rem; max-width: 90%;}
            #start-screen h1 { font-size: 1.6rem;}
            #start-screen p.intro-text { font-size: 0.8rem;}
            .difficulty-btn { min-width: 100px; padding: 0.4rem 0.7rem; font-size: 0.65rem;}
            .difficulty-btn .difficulty-icon { font-size: 1.2rem; }
            .start-actions-container { margin-top: 1rem; }
            #start-button, #help-button { font-size: 0.75rem; padding: 0.5rem 1rem; }
        }

        @media (max-width: 640px) { /* Ajustes mÃ¡s finos para mÃ³viles pequeÃ±os */
            .modal-content { padding: 1rem 1.2rem; }
            .modal-title { font-size: 1.1rem; margin-bottom: 1rem;}
            .modal-body p, .modal-body li { font-size: 0.7rem; }
            .modal-body button, #close-help-button { font-size: 0.7rem; padding: 0.5rem 0.8rem;}

            /* Ajustes mÃ¡s especÃ­ficos para Start Screen en mÃ³viles pequeÃ±os */
            #start-screen { padding: 0.8rem; }
            #start-screen h1 { font-size: 1.4rem; padding-bottom: 0.6rem; margin-bottom: 0.8rem;}
            #start-screen p.intro-text { font-size: 0.7rem; margin-bottom: 0.8rem; }
            #difficulty-selection label { font-size: 0.8rem; margin-bottom: 0.6rem; }
            .difficulty-btn { min-width: 90px; padding: 0.4rem 0.6rem; font-size: 0.6rem;}
            .difficulty-btn .difficulty-icon { font-size: 1.1rem; }
            .start-actions-container { flex-direction: column; gap: 0.6rem; margin-top: 0.8rem; width: 90%;} /* Apilar botones y reducir ancho */
            #start-button, #help-button { font-size: 0.7rem; padding: 0.5rem 1rem; width: 100%; max-width: 220px;}
            .start-screen-hint { font-size: 0.6rem; margin-top: 0.6rem; }


            .control-btn { width: 50px; height: 50px; font-size: 1.5rem; }
            #shoot-btn { width: 65px; height: 65px; font-size: 1.8rem; }
            #global-controls { gap: 0.4rem; margin-bottom: 0.6rem; }
            .global-btn { padding: 0.3rem 0.6rem; font-size: 0.6rem;}
            #pause-message { font-size: 1.3rem; padding: 1.2rem 1.8rem;}
            .final-screen .stat-final { font-size: 0.7rem; }
            .final-screen #high-score-display, .final-screen #fact-display { font-size: 0.65rem;}
        }

        @media (max-width: 400px) { /* Ajustes para pantallas muy pequeÃ±as */
            #start-screen h1 { font-size: 1.2rem; }
            #start-screen p.intro-text { font-size: 0.65rem;}
            #difficulty-selection label { font-size: 0.75rem; }
            .difficulty-btn { min-width: 80px; font-size: 0.55rem;}
            .difficulty-btn .difficulty-icon { font-size: 1rem; }
             #global-controls { flex-wrap: wrap; justify-content: space-around; } /* Permitir que los botones globales se envuelvan */
            .global-btn { flex-basis: 45%; margin-bottom: 0.3rem; } /* Para que quepan dos por lÃ­nea */
        }


        @media (hover: none) and (pointer: coarse), (max-width: 768px) { /* Mejor detecciÃ³n para mÃ³viles */
            #mobile-controls { display: flex; }
        }
    </style>

</head>
<body>
    <div id="global-controls">
        <button id="pause-btn" class="global-btn" disabled>â¸ï¸ Pausa</button>
        <button id="restart-btn-global" class="global-btn" disabled>ğŸ”„ Reiniciar</button>
        <button id="mute-btn" class="global-btn">ğŸ”ˆ Sonido</button>
    </div>

    <div class="container">
        <div id="start-screen">
            <h1>ğŸ‘¾ Invasores de la FÃ­sica ğŸš€</h1>
            <p class="intro-text">Â¡Esquiva balas ğŸ’¥, recoge Ã­tems ğŸ’ y demuestra tu conocimiento en fÃ­sica respondiendo preguntas! ğŸ§ </p>
            <div id="difficulty-selection">
                <label>ğŸ“ Selecciona la Dificultad (Preguntas por Nivel):</label>
                <div class="difficulty-options">
                    <button class="difficulty-btn" data-difficulty="easy">
                        <span class="difficulty-icon">âš›ï¸</span>FÃ¡cil (10)
                    </button>
                    <button class="difficulty-btn selected" data-difficulty="medium">
                        <span class="difficulty-icon">ğŸ§ª</span>Medio (15)
                    </button>
                    <button class="difficulty-btn" data-difficulty="hard">
                        <span class="difficulty-icon">ğŸ”¬</span>DifÃ­cil (20)
                    </button>
                </div>
            </div>
            <div class="start-actions-container">
                <button id="start-button">â–¶ï¸ Iniciar Juego</button>
                <button id="help-button">â„¹ï¸ Instrucciones</button>
            </div>
            <p class="start-screen-hint">(Usa â† â†’ / Espacio en teclado âŒ¨ï¸ o los botones en pantalla ğŸ“±)</p>
        </div>

        <div id="game-elements" style="display: none;">
            <div id="ui-bar">
                <div class="stat">ğŸ¯ Score: <span id="score">0</span></div>
                <div class="stat" id="lives">â¤ï¸ Vidas: <span >3</span></div>
                <div class="stat" id="level">ğŸŒŸ Nivel: <span >1</span></div>
                <div class="stat stat-questions">ğŸ§  P. Nivel: <span id="questions-answered-ui">0</span>/<span id="questions-target-ui">0</span> <br> â³ Restantes: <span id="questions-remaining-ui">0</span>
                    <div id="question-progress-bar-container"><div id="question-progress-bar"></div></div>
                </div>
            </div>
            <div id="pause-message">â¸ï¸ PAUSA â¸ï¸</div>
            <canvas id="gameCanvas"></canvas>
            <div id="mobile-controls">
                 <button id="left-btn" class="control-btn" aria-label="Mover Izquierda">â¬…ï¸</button>
                 <button id="shoot-btn" class="control-btn" aria-label="Disparar">ğŸ”¥</button>
                 <button id="right-btn" class="control-btn" aria-label="Mover Derecha">â¡ï¸</button>
            </div>
        </div>

        <div id="question-modal" class="modal-overlay">
             <div class="modal-content">
                 <h2 class="modal-title">ğŸ’¡ Â¡Pregunta de FÃ­sica! ğŸ’¡</h2>
                 <div class="modal-body">
                     <p id="question-counter-modal" style="font-weight:bold; color: var(--accent-blue); text-align:center;">Pregunta Nivel: X/Y</p>
                     <p id="question-text" style="font-size: 0.9rem; min-height: 50px; background-color: rgba(0,0,0,0.2); padding: 0.5rem; border-radius: 4px; font-weight: 700;">AquÃ­ va la pregunta...</p>
                     <div id="options-container" style="margin-top:1rem;"></div>
                     <div id="feedback-container" class="feedback" style="display: none;">
                         <div id="feedback-content"></div>
                         <button id="accept-feedback-btn" style="display: none;">âœ”ï¸ Entendido</button>
                     </div>
                 </div>
             </div>
        </div>

        <div id="game-over-modal" class="modal-overlay">
             <div id="game-over-screen" class="modal-content final-screen">
                 <h2 class="modal-title">â˜ ï¸ Game Over â˜ ï¸</h2>
                 <div class="modal-body">
                     <p id="final-message">Los invasores han ganado...</p>
                     <div class="stat-final">ğŸ¯ Score Final: <strong id="final-score">0</strong></div>
                     <div class="stat-final">ğŸŒŸ Nivel Alcanzado: <strong id="final-level">1</strong></div>
                     <div class="stat-final">ğŸ“ Dificultad: <strong id="final-difficulty">Medio</strong></div>
                     <div class="stat-final">ğŸ§  Preguntas Correctas (Total): <strong id="final-questions-correct-gameover">0</strong> / <strong id="final-questions-answered-gameover">0</strong></div>
                     <div class="stat-final">ğŸ… CalificaciÃ³n Juego: <span id="final-rating-gameover-stars" class="rating-stars"></span> (<strong id="final-rating-gameover-text" class="rating-display">0/5</strong>)</div>
                     <div id="high-score-display">ğŸ† Mejor Score (<span id="high-score-difficulty-gameover">Medio</span>): <strong id="high-score-gameover">0</strong></div>
                     <div id="fact-display"><i>ğŸ”­ Dato Curioso:</i> <span id="fact-text-gameover">...</span></div>
                     <button id="restart-button-gameover" class="play-again-button">ğŸ”„ Jugar de Nuevo</button>
                 </div>
             </div>
        </div>

        <div id="level-complete-modal" class="modal-overlay">
             <div id="level-complete-screen" class="modal-content final-screen">
                  <h2 class="modal-title">ğŸ‰ Â¡Nivel Superado! ğŸ‰</h2>
                  <div class="modal-body">
                      <p id="complete-message">Â¡Has detenido la invasiÃ³n... por ahora!</p>
                      <div class="stat-final">ğŸ¯ Score Acumulado: <strong id="complete-score">0</strong></div>
                      <div class="stat-final">ğŸŒŸ Nivel Completado: <strong id="complete-level">1</strong></div>
                      <div class="stat-final">ğŸ“ Dificultad: <strong id="complete-difficulty">Medio</strong></div>
                      <div class="stat-final">ğŸ§  Preguntas Correctas (Nivel): <strong id="complete-questions-correct">0</strong> / <strong id="complete-questions-answered">0</strong></div>
                      <div class="stat-final">ğŸ… CalificaciÃ³n Nivel: <span id="complete-rating-stars" class="rating-stars"></span> (<strong id="complete-rating-text" class="rating-display">0/5</strong>)</div>
                      <div id="high-score-display-complete">ğŸ† Mejor Score (<span id="high-score-difficulty-complete">Medio</span>): <strong id="high-score-complete">0</strong></div>
                      <div id="fact-display-complete"><i>ğŸ”­ Dato Curioso:</i> <span id="fact-text-complete">...</span></div>
                      <button id="next-level-button">â¡ï¸ Siguiente Nivel</button>
                      <button id="restart-button-complete" class="play-again-button">ğŸ”„ Reiniciar Juego</button>
                  </div>
             </div>
        </div>

        <div id="help-modal" class="modal-overlay">
            <div class="modal-content">
                <h2 class="modal-title">â„¹ï¸ Instrucciones del Juego â„¹ï¸</h2>
                <div class="modal-body">
                    <p>Â¡Defiende la Tierra ğŸŒ de los Invasores de la FÃ­sica!</p>
                    <ul>
                        <li><strong>ğŸ•¹ï¸ Movimiento:</strong> Usa las teclas <strong>â†</strong> y <strong>â†’</strong> o los botones en pantalla para mover tu nave ğŸš€.</li>
                        <li><strong>ğŸ’¥ Disparo:</strong> Presiona la <strong>Barra Espaciadora</strong> o el botÃ³n ğŸ”¥ para disparar.</li>
                        <li><strong>ğŸ¯ Objetivo:</strong> Elimina a todos los invasores ğŸ‘¾ y responde las preguntas â“ requeridas para pasar de nivel.</li>
                        <li><strong>ğŸ§  Preguntas:</strong> Recoge los Ã­tems â“ para pausar el juego y responder una pregunta de fÃ­sica. Â¡Responder correctamente te da puntos extra y cuenta para el objetivo del nivel!</li>
                        <li><strong>ğŸŒŠ Oleadas:</strong> Si eliminas a todos los invasores antes de completar las preguntas, Â¡aparecerÃ¡ una nueva oleada!</li>
                        <li><strong>ğŸ’ Otros Ãtems:</strong>
                            <ul>
                                <li>ğŸ’š: Vida extra</li>
                                <li>ğŸ’£: Elimina todos los invasores en pantalla (Â¡no da puntos!)</li>
                                <li>ğŸ’°: Puntos extra</li>
                                <li>âš¡: Disparo rÃ¡pido temporal</li>
                                <li>ğŸ›¡ï¸: Escudo temporal</li>
                            </ul>
                        </li>
                        <li><strong>â¸ï¸ Pausa:</strong> Usa el botÃ³n 'Pausa' global.</li>
                        <li><strong>ğŸ”„ Reiniciar:</strong> Usa el botÃ³n 'Reiniciar' global.</li>
                        <li><strong>ğŸ”ˆ Sonido:</strong> Usa el botÃ³n 'Sonido' global para activar/desactivar.</li>
                    </ul>
                    <button id="close-help-button">ğŸ‘ Â¡Entendido!</button>
                </div>
            </div>
        </div>
    </div>

    <footer>
        Desarrollado con âœ¨ por Msc: NÃ©stor Fabio Montoya Palacios (VersiÃ³n Mejorada por IA)
    </footer>

    <script>
        // --- Polyfill para requestAnimationFrame ---
        window.requestAnimationFrame = window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame || function(callback) {
            window.setTimeout(callback, 1000 / 60);
        };

        // --- Constantes y Variables Globales ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // Elementos UI
        const scoreElement = document.getElementById('score');
        const livesElement = document.getElementById('lives').querySelector('span');
        const levelElement = document.getElementById('level').querySelector('span');
        const questionsAnsweredUI = document.getElementById('questions-answered-ui');
        const questionsTargetUI = document.getElementById('questions-target-ui');
        const questionsRemainingUI = document.getElementById('questions-remaining-ui'); // Nuevo
        const questionProgressBar = document.getElementById('question-progress-bar'); // Nuevo

        // Mensajes y Pantallas
        const pauseMessage = document.getElementById('pause-message');
        const startScreen = document.getElementById('start-screen');
        const gameElements = document.getElementById('game-elements');

        // Botones Globales
        const pauseBtn = document.getElementById('pause-btn');
        const restartBtnGlobal = document.getElementById('restart-btn-global');
        const muteBtn = document.getElementById('mute-btn'); // Nuevo

        // Controles MÃ³viles
        const mobileControls = document.getElementById('mobile-controls');
        const leftBtn = document.getElementById('left-btn');
        const rightBtn = document.getElementById('right-btn');
        const shootBtn = document.getElementById('shoot-btn');

        // Modales
        const questionModal = document.getElementById('question-modal');
        const gameOverModal = document.getElementById('game-over-modal');
        const levelCompleteModal = document.getElementById('level-complete-modal');
        const helpModal = document.getElementById('help-modal');

        // Sonidos (usando Tone.js)
        let soundsEnabled = true; // Sonido activado por defecto
        let audioInitialized = false; // Para controlar la primera inicializaciÃ³n de Tone.js
        let playerShootSynth, invaderShootSynth, explosionSynth, itemPickupSynth, questionSynth, correctSynth, incorrectSynth, waveClearSynth;

        function initializeSounds() {
            if (typeof Tone !== 'undefined' && !audioInitialized) {
                try {
                    // Crear sintetizadores
                    playerShootSynth = new Tone.Synth({ oscillator: { type: "square" }, envelope: { attack: 0.01, decay: 0.1, sustain: 0, release: 0.1 } }).toDestination();
                    invaderShootSynth = new Tone.Synth({ oscillator: { type: "sawtooth" }, envelope: { attack: 0.01, decay: 0.15, sustain: 0, release: 0.1 } }).toDestination();
                    explosionSynth = new Tone.NoiseSynth({ noise: { type: "white" }, envelope: { attack: 0.005, decay: 0.1, sustain: 0 } }).toDestination();
                    itemPickupSynth = new Tone.Synth({ oscillator: { type: "triangle" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.1 } }).toDestination();
                    questionSynth = new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.05, decay: 0.3, sustain: 0.1, release: 0.2 } }).toDestination();
                    correctSynth = new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.1 } }).toDestination();
                    incorrectSynth = new Tone.Synth({ oscillator: { type: "square" }, envelope: { attack: 0.01, decay: 0.3, sustain: 0, release: 0.1 } }).toDestination();
                    waveClearSynth = new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.2, release: 0.2 } }).toDestination();

                    audioInitialized = true;
                    console.log("ğŸ”Š Sonidos inicializados con Tone.js");
                } catch (error) {
                    console.error("Error inicializando Tone.js:", error);
                    audioInitialized = false; // Marcar como no inicializado si falla
                    soundsEnabled = false; // Desactivar sonidos si hay error
                    muteBtn.textContent = 'ğŸ”‡ Sonido OFF';
                }
            } else if (!audioInitialized) {
                console.warn("Tone.js no estÃ¡ cargado o ya hubo un error. Los sonidos estÃ¡n desactivados.");
                soundsEnabled = false;
                muteBtn.textContent = 'ğŸ”‡ Sonido OFF';
            }
        }

        function playSound(type) {
            if (!soundsEnabled || !audioInitialized || typeof Tone === 'undefined' || !Tone.context || Tone.context.state !== 'running') return;
            try {
                switch (type) {
                    case 'playerShoot': if (playerShootSynth) playerShootSynth.triggerAttackRelease("C5", "8n", Tone.now()); break;
                    case 'invaderShoot': if (invaderShootSynth) invaderShootSynth.triggerAttackRelease("G3", "8n", Tone.now()); break;
                    case 'explosion': if (explosionSynth) explosionSynth.triggerAttackRelease("4n", Tone.now()); break;
                    case 'itemPickup': if (itemPickupSynth) itemPickupSynth.triggerAttackRelease("E6", "16n", Tone.now()); break;
                    case 'questionAppear': if (questionSynth) questionSynth.triggerAttackRelease("A4", "4n", Tone.now()); break;
                    case 'correctAnswer': if (correctSynth) correctSynth.triggerAttackRelease("C6", "8n", Tone.now()); break;
                    case 'incorrectAnswer': if (incorrectSynth) incorrectSynth.triggerAttackRelease("C3", "4n", Tone.now()); break;
                    case 'waveClear': if (waveClearSynth) waveClearSynth.triggerAttackRelease("G5", "4n", Tone.now()); break;
                }
            } catch (error) {
                console.error(`Error al reproducir sonido '${type}':`, error);
            }
        }

        function toggleMute() {
            soundsEnabled = !soundsEnabled;
            muteBtn.textContent = soundsEnabled ? 'ğŸ”ˆ Sonido ON' : 'ğŸ”‡ Sonido OFF';
            console.log(soundsEnabled ? "Sonidos activados" : "Sonidos desactivados");
            if (soundsEnabled && typeof Tone !== 'undefined' && Tone.context.state === 'suspended') {
                 Tone.start().then(() => {
                    console.log("AudioContext reanudado por usuario.");
                    if (!audioInitialized) initializeSounds();
                 }).catch(err => console.error("Error reanudando AudioContext:", err));
            }
        }
        muteBtn.addEventListener('click', toggleMute);


        // Estado del juego
        let player;
        let invaderGrid;
        let playerBullets = [];
        let invaderBullets = [];
        let items = [];
        let particles = [];

        let score = 0;
        let lives = 3;
        let level = 1;
        let wave = 1;
        let gameOver = false;
        let gamePaused = false;
        let gameRunning = false;
        let currentDifficulty = 'medium';
        let questionsPerLevel = { easy: 10, medium: 15, hard: 20 };
        let questionsTarget = 0;
        let questionsAnsweredThisLevel = 0;
        let questionsCorrectThisLevel = 0;
        let totalQuestionsAnsweredGame = 0;
        let totalQuestionsCorrectGame = 0;
        let currentQuestionData = null;
        let lastTime = 0;
        let keys = {};
        let shootCooldown = 0;
        const SHOOT_COOLDOWN_TIME = 300;
        let fastShootActive = false;
        let fastShootTimer = 0;
        const FAST_SHOOT_DURATION = 5000;
        let shieldActive = false;
        let shieldTimer = 0;
        const SHIELD_DURATION = 5000;

        // --- Clases del Juego (Sin cambios mayores, solo comentarios y leves ajustes) ---
        class Player {
             constructor(x, y, width, height, canvas) {
                 this.canvas = canvas;
                 this.baseWidth = width;
                 this.baseHeight = height;
                 this.width = this.baseWidth;
                 this.height = this.baseHeight;
                 this.x = x - this.width / 2;
                 this.y = y - this.height / 2;
                 this.speed = 5;
                 this.emoji = 'ğŸš€';
                 this.rotation = -Math.PI / 4;  // Removida la rotaciÃ³n inicial para que la nave apunte hacia arriba
                 this.hit = false;
                 this.hitTimer = 0;
                 this.hitDuration = 1000;
             }

             draw(ctx) {
                 if (this.hit && Math.floor(this.hitTimer / 80) % 2 === 0) {
                     return;
                 }

                 ctx.save();
                 const centerX = this.x + this.width / 2;
                 const centerY = this.y + this.height / 2;
                 ctx.translate(centerX, centerY);
                 ctx.rotate(this.rotation); // RotaciÃ³n (actualmente 0)

                 ctx.font = `${this.width * 1.1}px Arial`;
                 ctx.textAlign = 'center';
                 ctx.textBaseline = 'middle';
                 ctx.fillText(this.emoji, 0, 0);

                 if (shieldActive) {
                     const shieldRadius = Math.max(this.width, this.height) * 0.8;
                     ctx.beginPath();
                     ctx.arc(0, 0, shieldRadius, 0, Math.PI * 2);
                     const shieldPulse = Math.abs(Math.sin(performance.now() / 200));
                     ctx.strokeStyle = `rgba(0, 255, 255, ${0.5 + shieldPulse * 0.5})`;
                     ctx.lineWidth = 2 + shieldPulse * 2;
                     ctx.setLineDash([8, 4]);
                     ctx.stroke();
                     ctx.setLineDash([]);
                 }
                 ctx.restore();
             }

             move(direction) {
                 if (gamePaused || this.hit) return;

                 if (direction === 'left') {
                     this.x -= this.speed;
                 } else if (direction === 'right') {
                     this.x += this.speed;
                 }
                 this.x = Math.max(0, Math.min(this.x, this.canvas.width - this.width));
             }

             shoot() {
                 if (shootCooldown <= 0 && !gamePaused) {
                     playSound('playerShoot');
                     const centerX = this.x + this.width / 2;
                     const bulletWidth = 4;
                     const bulletHeight = 15;
                     const bulletColor = getComputedStyle(document.documentElement).getPropertyValue('--player-bullet-color').trim();
                     // La bala sale de la parte superior de la nave (sin considerar rotaciÃ³n compleja)
                     playerBullets.push(new Bullet(centerX - bulletWidth / 2, this.y, bulletWidth, bulletHeight, bulletColor, 8, true));
                     shootCooldown = fastShootActive ? SHOOT_COOLDOWN_TIME / 3 : SHOOT_COOLDOWN_TIME;
                 }
             }

             update(deltaTime) {
                 if (shootCooldown > 0) shootCooldown -= deltaTime;
                 if (this.hit) {
                     this.hitTimer += deltaTime;
                     if (this.hitTimer >= this.hitDuration) {
                         this.hit = false;
                         this.hitTimer = 0;
                     }
                 }
                 if (fastShootActive) {
                     fastShootTimer -= deltaTime;
                     if (fastShootTimer <= 0) fastShootActive = false;
                 }
                 if (shieldActive) {
                     shieldTimer -= deltaTime;
                     if (shieldTimer <= 0) shieldActive = false;
                 }
             }

             activateFastShoot() { fastShootActive = true; fastShootTimer = FAST_SHOOT_DURATION; }
             activateShield() { shieldActive = true; shieldTimer = SHIELD_DURATION; }

             reset() {
                 this.x = this.canvas.width / 2 - this.width / 2;
                 this.y = this.canvas.height - this.height - 20;
                 this.hit = false;
                 this.hitTimer = 0;
                 fastShootActive = false;
                 shieldActive = false;
             }

             takeHit() {
                 if (!this.hit && !shieldActive) {
                     lives--;
                     this.hit = true;
                     this.hitTimer = 0;
                     playSound('explosion');
                     createExplosion(this.x + this.width / 2, this.y + this.height / 2, getComputedStyle(document.documentElement).getPropertyValue('--accent-red').trim());
                     updateUI();
                     if (lives <= 0) {
                         triggerGameOver("Â¡Tu nave ğŸš€ ha sido destruida!");
                     }
                     return true;
                 } else if (shieldActive) {
                     playSound('itemPickup');
                     shieldTimer -= 500;
                     if (shieldTimer <= 0) shieldActive = false;
                     createExplosion(this.x + this.width/2, this.y + this.height/2, getComputedStyle(document.documentElement).getPropertyValue('--item-shield-color').trim(), 5);
                 }
                 return false;
             }
        }

        class Bullet {
             constructor(x, y, width, height, color, speed, isPlayerBullet) {
                 this.x = x; this.y = y; this.width = width; this.height = height;
                 this.color = color; this.speed = speed; this.isPlayerBullet = isPlayerBullet;
                 this.vy = isPlayerBullet ? -speed : speed;
             }
             update(deltaTime) { this.y += this.vy * (deltaTime / 16.67); }
             draw(ctx) {
                 ctx.save();
                 ctx.fillStyle = this.color; // Usar fillStyle para balas sÃ³lidas
                 // Dibujar un rectÃ¡ngulo simple para la bala, puede ser mejorado con un estilo lÃ¡ser
                 ctx.fillRect(this.x, this.y, this.width, this.height);
                 // Efecto de "glow" simple
                 ctx.shadowBlur = 5;
                 ctx.shadowColor = this.color;
                 ctx.fillRect(this.x, this.y, this.width, this.height); // Dibujar de nuevo con glow
                 ctx.restore();
             }
             isOffscreen(canvasHeight) { return this.y + this.height < 0 || this.y > canvasHeight; }
        }

        class Invader {
             constructor(x, y, width, height, type = 'ğŸ‘¾', points = 10) {
                 this.x = x; this.y = y; this.width = width; this.height = height;
                 this.emoji = type; this.points = points;
                 this.hit = false; this.hitTimer = 0; this.hitDuration = 150;
             }
             draw(ctx) {
                 let currentEmoji = this.emoji; let drawX = this.x; let drawY = this.y;
                 if (this.hit) {
                     if (Math.random() > 0.5) {
                         ctx.filter = `brightness(${1 + Math.random() * 0.5}) contrast(${1 + Math.random() * 0.5})`;
                         drawX += (Math.random() - 0.5) * 4; drawY += (Math.random() - 0.5) * 4;
                     } else { currentEmoji = 'ğŸ’¥'; }
                 }
                 ctx.font = `${this.width}px Arial`; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                 ctx.fillText(currentEmoji, drawX + this.width / 2, drawY + this.height / 2);
                 ctx.filter = 'none';
             }
             update(deltaTime) { if (this.hit) this.hitTimer += deltaTime; }
             shoot() {
                 playSound('invaderShoot');
                 const bulletWidth = 4; const bulletHeight = 10;
                 const bulletColor = getComputedStyle(document.documentElement).getPropertyValue('--invader-bullet-color').trim();
                 invaderBullets.push(new Bullet(this.x + this.width / 2 - bulletWidth / 2, this.y + this.height, bulletWidth, bulletHeight, bulletColor, 4 + level * 0.5, false));
             }
        }

        class InvaderGrid {
             constructor(cols, rows, invaderWidth, invaderHeight, spacingX, spacingY, startY, canvasWidth) {
                 this.cols = cols; this.rows = rows;
                 this.invaderWidth = invaderWidth; this.invaderHeight = invaderHeight;
                 this.spacingX = spacingX; this.spacingY = spacingY;
                 this.startY = startY; this.canvasWidth = canvasWidth;
                 this.invaders = []; this.direction = 1;
                 this.speed = 1 + level * 0.2 + (wave - 1) * 0.1;
                 this.shootInterval = Math.max(250, 1500 - level * 100 - (wave - 1) * 50);
                 this.shootTimer = this.shootInterval;
                 this.totalWidth = cols * invaderWidth + (cols - 1) * spacingX;
                 this.x = (canvasWidth - this.totalWidth) / 2; this.y = startY;
                 this.createGrid();
             }
             createGrid() {
                 this.invaders = [];
                 const invaderTypes = ['ğŸ‘¾', 'ğŸ‘½', 'ğŸ‘»', 'ğŸ’€', 'ğŸ¤–']; const points = [10, 20, 30, 40, 50];
                 for (let r = 0; r < this.rows; r++) {
                     for (let c = 0; c < this.cols; c++) {
                         const invaderX = this.x + c * (this.invaderWidth + this.spacingX);
                         const invaderY = this.y + r * (this.invaderHeight + this.spacingY);
                         const typeIndex = r % invaderTypes.length;
                         this.invaders.push(new Invader(invaderX, invaderY, this.invaderWidth, this.invaderHeight, invaderTypes[typeIndex], points[typeIndex]));
                     }
                 }
             }
             update(deltaTime) {
                 this.invaders.forEach(invader => invader.update(deltaTime));
                 this.invaders = this.invaders.filter(invader => !(invader.hit && invader.hitTimer >= invader.hitDuration));
                 if (this.invaders.length === 0) return;

                 let moveDown = false; const dx = this.direction * this.speed * (deltaTime / 16.67);
                 let currentMinX = Infinity; let currentMaxX = -Infinity;
                 this.invaders.forEach(invader => { currentMinX = Math.min(currentMinX, invader.x); currentMaxX = Math.max(currentMaxX, invader.x + invader.width); });

                 if ((this.direction === 1 && currentMaxX + dx > this.canvasWidth) || (this.direction === -1 && currentMinX + dx < 0)) {
                     this.direction *= -1; moveDown = true; this.speed += 0.02;
                 }
                 this.invaders.forEach(invader => { if (moveDown) invader.y += this.invaderHeight / 5; else invader.x += dx; });

                 this.shootTimer -= deltaTime;
                 if (this.shootTimer <= 0 && !gamePaused) { this.tryShoot(); this.shootTimer = Math.max(200, this.shootInterval - Math.random() * 500); }
             }
             draw(ctx) { this.invaders.forEach(invader => invader.draw(ctx)); }
             tryShoot() {
                 if (this.invaders.length > 0) {
                     const bottomInvaders = {}; let firstInvaderX = this.invaders.length > 0 ? this.invaders[0].x : 0;
                     this.invaders.forEach(inv => {
                         const col = Math.round((inv.x - firstInvaderX) / (this.invaderWidth + this.spacingX));
                         if (!bottomInvaders[col] || inv.y > bottomInvaders[col].y) bottomInvaders[col] = inv;
                     });
                     const shooters = Object.values(bottomInvaders);
                     if (shooters.length > 0) shooters[Math.floor(Math.random() * shooters.length)].shoot();
                 }
             }
             checkGameOver(playerY) { return this.invaders.some(invader => invader.y + invader.height >= playerY); }
             clearAll() {
                 this.invaders.forEach(inv => createExplosion(inv.x + inv.width / 2, inv.y + inv.height / 2));
                 this.invaders = []; score += 50 * level; updateUI();
             }
        }

        class Item {
             constructor(x, y, type) {
                 this.x = x; this.y = y; this.width = 25; this.height = 25; this.type = type;
                 this.speed = 2 + Math.random() * 1; this.emoji = this.getEmoji(); this.color = this.getColor();
                 this.rotation = 0; this.rotationSpeed = (Math.random() - 0.5) * 0.1;
             }
             getEmoji() {
                 switch (this.type) {
                     case 'life': return 'ğŸ’š'; case 'bomb': return 'ğŸ’£'; case 'score': return 'ğŸ’°';
                     case 'question': return 'â“'; case 'fastshoot': return 'âš¡'; case 'shield': return 'ğŸ›¡ï¸';
                     default: return 'ğŸ’';
                 }
             }
             getColor() { return '#FFFFFF';}
             update(deltaTime) { this.y += this.speed * (deltaTime / 16.67); this.rotation += this.rotationSpeed * (deltaTime / 16.67); }
             draw(ctx) {
                 ctx.save(); const centerX = this.x + this.width / 2; const centerY = this.y + this.height / 2;
                 ctx.translate(centerX, centerY); ctx.rotate(this.rotation);
                 ctx.font = `${this.width * 0.9}px Arial`; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                 ctx.fillText(this.emoji, 0, 0); ctx.restore();
             }
             isOffscreen(canvasHeight) { return this.y > canvasHeight; }
        }

        class Particle {
             constructor(x, y, color) {
                 this.x = x; this.y = y; this.size = Math.random() * 3 + 2;
                 const angle = Math.random() * Math.PI * 2; const speed = Math.random() * 3 + 1;
                 this.speedX = Math.cos(angle) * speed; this.speedY = Math.sin(angle) * speed;
                 this.color = color || '#FFF'; this.life = Math.random() * 600 + 300;
                 this.initialLife = this.life; this.gravity = 0.05; this.alpha = 1;
             }
             update(deltaTime) {
                 this.speedY += this.gravity * (deltaTime / 16.67);
                 this.x += this.speedX * (deltaTime / 16.67); this.y += this.speedY * (deltaTime / 16.67);
                 this.life -= deltaTime; this.alpha = Math.max(0, this.life / this.initialLife);
                 this.size = Math.max(0, this.size * (this.life / this.initialLife));
             }
             draw(ctx) {
                 ctx.save(); ctx.fillStyle = this.color; ctx.globalAlpha = this.alpha;
                 ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill();
                 ctx.restore();
             }
        }


        // --- Funciones Principales del Juego ---

        function initGame(difficulty) {
            console.log(`ğŸš€ Iniciando juego en dificultad: ${difficulty}`);
            currentDifficulty = difficulty;
            questionsTarget = questionsPerLevel[difficulty];

            score = 0; lives = 3; level = 1; wave = 1;
            gameOver = false; gamePaused = false; gameRunning = true;
            playerBullets = []; invaderBullets = []; items = []; particles = [];
            questionsAnsweredThisLevel = 0; questionsCorrectThisLevel = 0;
            totalQuestionsAnsweredGame = 0; totalQuestionsCorrectGame = 0;
            currentQuestionData = null; shootCooldown = 0;
            fastShootActive = false; shieldActive = false;

            resizeCanvas();

            const playerWidth = canvas.width * 0.055;
            const playerHeight = playerWidth * 0.85; // Mantener proporciÃ³n original
            player = new Player(canvas.width / 2, canvas.height - playerHeight - 20, playerWidth, playerHeight, canvas);

            setupLevel();
            updateUI();

            startScreen.style.display = 'none';
            gameElements.style.display = 'block';
            pauseBtn.disabled = false; pauseBtn.textContent = 'â¸ï¸ Pausa';
            restartBtnGlobal.disabled = false;

            if (typeof Tone !== 'undefined') {
                if (Tone.context.state !== 'running') {
                    console.log("ğŸ”Š Esperando interacciÃ³n para iniciar audio (Tone.start())...");
                } else if (!audioInitialized) {
                    initializeSounds();
                }
            } else {
                console.warn("Tone.js no disponible. Iniciando sin sonido.");
                soundsEnabled = false; muteBtn.textContent = 'ğŸ”‡ Sonido OFF';
            }
            lastTime = performance.now();
            gameLoop(lastTime);
        }

        function setupLevel() {
            wave = 1;
            playerBullets = []; invaderBullets = []; items = [];
            regenerateInvaders();
            if (player) player.reset();
            updateUI();
            console.log(`ğŸŒŸ Nivel ${level} (Oleada ${wave}) configurado.`);
        }

        function regenerateInvaders() {
            console.log(`ğŸŒŠ Regenerando oleada ${wave} para Nivel ${level}...`);
            playSound('waveClear');

            const cols = Math.min(10, 8 + Math.min(level - 1, 3) + Math.floor((wave-1)/2));
            const rows = Math.min(6, 4 + Math.floor((level - 1) / 2));
            const invaderBaseWidth = canvas.width * 0.055;
            const invaderWidth = Math.max(20, invaderBaseWidth);
            const invaderHeight = invaderWidth * 0.8;
            const spacingX = invaderWidth * 0.35;
            const spacingY = invaderHeight * 0.45;
            const startY = Math.max(30, 50 - (level-1)*5);

            invaderGrid = new InvaderGrid(cols, rows, invaderWidth, invaderHeight, spacingX, spacingY, startY, canvas.width);

            if (wave > 1) {
                score += 25 * level * wave; updateUI();
            }
        }

        function updateUI() {
            scoreElement.textContent = score;
            livesElement.textContent = lives;
            levelElement.textContent = level;
            questionsAnsweredUI.textContent = questionsAnsweredThisLevel;
            questionsTargetUI.textContent = questionsTarget;
            const remaining = Math.max(0, questionsTarget - questionsAnsweredThisLevel);
            questionsRemainingUI.textContent = remaining;
            const progressPercent = questionsTarget > 0 ? (questionsAnsweredThisLevel / questionsTarget) * 100 : 0;
            questionProgressBar.style.width = `${progressPercent}%`;
        }

        function handleInput(deltaTime) {
            if (!player || gamePaused || isModalVisible()) return;
            if (keys['ArrowLeft'] || keys['touchLeft']) player.move('left');
            if (keys['ArrowRight'] || keys['touchRight']) player.move('right');
            if (keys[' '] || keys['touchShoot']) player.shoot();
        }

        function drawGame() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach(p => p.draw(ctx));
            if (player) player.draw(ctx);
            if (invaderGrid) invaderGrid.draw(ctx);
            playerBullets.forEach(bullet => bullet.draw(ctx));
            invaderBullets.forEach(bullet => bullet.draw(ctx));
            items.forEach(item => item.draw(ctx));
        }

        function updateGame(deltaTime) {
            if (player) player.update(deltaTime);
            if (invaderGrid) invaderGrid.update(deltaTime);

            playerBullets.forEach(bullet => bullet.update(deltaTime));
            playerBullets = playerBullets.filter(bullet => !bullet.isOffscreen(canvas.height));
            invaderBullets.forEach(bullet => bullet.update(deltaTime));
            invaderBullets = invaderBullets.filter(bullet => !bullet.isOffscreen(canvas.height));

            items.forEach(item => item.update(deltaTime));
            items = items.filter(item => !item.isOffscreen(canvas.height));
            particles.forEach(particle => particle.update(deltaTime));
            particles = particles.filter(particle => particle.life > 0);

            checkCollisions();

            if (invaderGrid && invaderGrid.checkGameOver(player.y)) {
                triggerGameOver("Â¡Los invasores ğŸ‘¾ han llegado a la base!");
                return;
            }

            if (invaderGrid && invaderGrid.invaders.length === 0 && !gameOver && !isModalVisible()) {
                if (checkLevelCompletion()) {
                    triggerLevelComplete();
                } else {
                    wave++;
                    regenerateInvaders();
                }
            }
        }

        function gameLoop(timestamp) {
            if (!gameOver) {
                requestAnimationFrame(gameLoop);
            }
            const deltaTime = timestamp - lastTime;
            lastTime = timestamp;
            const dt = Math.min(deltaTime, 50);

            if (!gamePaused && !isModalVisible()) {
                handleInput(dt);
                updateGame(dt);
            }
            drawGame();
        }

        function togglePause() {
            if (gameOver || isModalVisible()) return;
            gamePaused = !gamePaused;
            pauseMessage.style.display = gamePaused ? 'block' : 'none';
            pauseBtn.textContent = gamePaused ? 'â–¶ï¸ Reanudar' : 'â¸ï¸ Pausa';
            console.log(gamePaused ? "â¸ï¸ Juego pausado" : "â–¶ï¸ Juego reanudado");
            if (!gamePaused) {
                 lastTime = performance.now();
            }
        }

        function restartGame() {
            console.log("ğŸ”„ Reiniciando juego...");
            gameOver = true; gameRunning = false; gamePaused = false;
            hideModal(gameOverModal); hideModal(levelCompleteModal); hideModal(questionModal);
            startScreen.style.display = 'block';
            gameElements.style.display = 'none';
            pauseBtn.disabled = true; pauseBtn.textContent = 'â¸ï¸ Pausa';
            restartBtnGlobal.disabled = true;
            pauseMessage.style.display = 'none';
            player = null; invaderGrid = null;
            playerBullets = []; invaderBullets = []; items = []; particles = [];
        }

        function checkCollisions() {
             if (!player || !invaderGrid) return;

             for (let i = playerBullets.length - 1; i >= 0; i--) {
                 const bullet = playerBullets[i];
                 for (let j = invaderGrid.invaders.length - 1; j >= 0; j--) {
                     const invader = invaderGrid.invaders[j];
                     if (!invader.hit &&
                         bullet.x < invader.x + invader.width && bullet.x + bullet.width > invader.x &&
                         bullet.y < invader.y + invader.height && bullet.y + bullet.height > invader.y)
                     {
                         score += invader.points * level;
                         invader.hit = true; invader.hitTimer = 0;
                         playSound('explosion');
                         createExplosion(invader.x + invader.width / 2, invader.y + invader.height / 2);
                         playerBullets.splice(i, 1);
                         if (Math.random() < 0.20 + level * 0.02) {
                             dropItem(invader.x + invader.width / 2, invader.y + invader.height / 2);
                         }
                         updateUI();
                         break;
                     }
                 }
             }

             for (let i = invaderBullets.length - 1; i >= 0; i--) {
                 const bullet = invaderBullets[i];
                 const playerCenterX = player.x + player.width / 2; const playerCenterY = player.y + player.height / 2;
                 const bulletCenterX = bullet.x + bullet.width / 2; const bulletCenterY = bullet.y + bullet.height / 2;

                 if (shieldActive) {
                     const shieldRadiusSq = (Math.max(player.width, player.height) * 0.8) ** 2;
                     const distSq = (bulletCenterX - playerCenterX) ** 2 + (bulletCenterY - playerCenterY) ** 2;
                     if (distSq < shieldRadiusSq) {
                         invaderBullets.splice(i, 1); player.takeHit(); continue;
                     }
                 }
                 if (!player.hit && !shieldActive &&
                     bullet.x < player.x + player.width && bullet.x + bullet.width > player.x &&
                     bullet.y < player.y + player.height && bullet.y + bullet.height > player.y)
                 {
                     invaderBullets.splice(i, 1); player.takeHit();
                 }
             }

             for (let i = items.length - 1; i >= 0; i--) {
                 const item = items[i];
                 if (item.x < player.x + player.width && item.x + item.width > player.x &&
                     item.y < player.y + player.height && item.y + item.height > player.y)
                 {
                     playSound('itemPickup'); activateItemEffect(item.type);
                     items.splice(i, 1); updateUI();
                 }
             }

             if (!player.hit && !shieldActive) {
                 for (let i = invaderGrid.invaders.length - 1; i >= 0; i--) {
                     const invader = invaderGrid.invaders[i];
                     if (invader.x < player.x + player.width && invader.x + invader.width > player.x &&
                         invader.y < player.y + player.height && invader.y + invader.height > player.y)
                     {
                         console.log("ğŸ’¥ Â¡ColisiÃ³n directa invasor-jugador!");
                         createExplosion(invader.x + invader.width / 2, invader.y + invader.height / 2);
                         invader.hit = true; invader.hitTimer = 0;
                         player.takeHit();
                     }
                 }
             }
        }

        function createExplosion(x, y, color = '#FFFFFF', count = 15) {
            for (let i = 0; i < count; i++) {
                particles.push(new Particle(x, y, color));
            }
        }

        function dropItem(x, y) {
            const weightedTypes = [
                { type: 'score', weight: 4 },
                { type: 'question', weight: 5 },
                { type: 'fastshoot', weight: 2 },
                { type: 'shield', weight: 2 },
                { type: 'life', weight: 1 },
                { type: 'bomb', weight: 1 }
            ];
            const totalWeight = weightedTypes.reduce((sum, item) => sum + item.weight, 0);
            let randomNum = Math.random() * totalWeight;
            let chosenType = 'score';
            for (const item of weightedTypes) {
                if (randomNum < item.weight) { chosenType = item.type; break; }
                randomNum -= item.weight;
            }
            items.push(new Item(x - 12.5, y - 12.5, chosenType));
        }

        function activateItemEffect(type) {
            console.log(`ğŸ’ Item recogido: ${type}`);
            switch (type) {
                case 'life': if (lives < 5) lives++; else score += 50 * level; break;
                case 'bomb': if (invaderGrid) invaderGrid.clearAll(); break;
                case 'score': score += 100 * level; break;
                case 'question':
                    if (gameRunning && !isModalVisible() && currentQuestionData === null) {
                         askQuestion('icon');
                    } else { console.warn("Intento de lanzar pregunta â“ mientras otra estÃ¡ activa o juego pausado."); }
                    break;
                case 'fastshoot': if (player) player.activateFastShoot(); break;
                case 'shield': if (player) player.activateShield(); break;
                default: console.warn(`Tipo de Ã­tem desconocido: ${type}`);
            }
            updateUI();
        }

        // --- LÃ³gica de Preguntas (BANCO SIN CAMBIOS) ---
        const physicsQuestions = [
            // ... (BANCO DE PREGUNTAS COMPLETO VA AQUÃ - OMITIDO POR BREVEDAD, PERO NO SE HA CAMBIADO) ...
            // COPIAR Y PEGAR EL BANCO DE PREGUNTAS ORIGINAL AQUÃ
    // ------------------------------------------------------------------------------------
    // TEMA: MAGNITUDES FÃSICAS
    // ------------------------------------------------------------------------------------
    // --- Dificultad: FÃ¡cil ---
    {
        question: "Â¿CuÃ¡l de las siguientes es una magnitud fÃ­sica fundamental en el Sistema Internacional (SI)?",
        options: ["Velocidad", "Fuerza", "Masa", "AceleraciÃ³n"],
        answer: 2,
        explanation: "La masa (kg) es una de las 7 magnitudes fundamentales del SI. Las otras (longitud, tiempo, corriente elÃ©ctrica, temperatura, cantidad de sustancia, intensidad luminosa) tambiÃ©n lo son. Velocidad, fuerza y aceleraciÃ³n son magnitudes derivadas.",
        difficulty: 'easy',
        topic: "Magnitudes FÃ­sicas"
    },
    {
        question: "La temperatura es una magnitud...",
        options: ["Vectorial", "Escalar", "Fundamental y Vectorial", "Derivada y Escalar"],
        answer: 1,
        explanation: "La temperatura se define completamente con un nÃºmero y una unidad (ej: 25 Â°C), no requiere direcciÃ³n ni sentido. Por lo tanto, es una magnitud escalar. TambiÃ©n es una magnitud fundamental en el SI (Kelvin).",
        difficulty: 'easy',
        topic: "Magnitudes FÃ­sicas"
    },
    {
        question: "Â¿QuÃ© tipo de magnitud es el tiempo?",
        options: ["Vectorial", "Escalar", "Derivada", "Compuesta"],
        answer: 1,
        explanation: "El tiempo es una magnitud escalar fundamental. Se mide en segundos (s) en el SI.",
        difficulty: 'easy',
        topic: "Magnitudes FÃ­sicas"
    },
    {
        question: "La longitud es una magnitud fÃ­sica que se considera...",
        options: ["Derivada y escalar", "Fundamental y escalar", "Derivada y vectorial", "Fundamental y vectorial"],
        answer: 1,
        explanation: "La longitud es una de las siete magnitudes fundamentales del SI y es escalar, ya que se describe completamente con un valor numÃ©rico y una unidad (ej: metros).",
        difficulty: 'easy',
        topic: "Magnitudes FÃ­sicas"
    },
    // --- Dificultad: Medio ---
    {
        question: "El desplazamiento se diferencia de la distancia recorrida en que el desplazamiento es una magnitud...",
        options: ["Escalar que siempre es positiva", "Vectorial", "Escalar que puede ser negativa", "Adimensional"],
        answer: 1,
        explanation: "El desplazamiento es una magnitud vectorial, ya que indica el cambio de posiciÃ³n y tiene magnitud, direcciÃ³n y sentido. La distancia recorrida es una magnitud escalar.",
        difficulty: 'medium',
        topic: "Magnitudes FÃ­sicas"
    },
    {
        question: "La velocidad es una magnitud __________, mientras que la rapidez es una magnitud __________.",
        options: ["Escalar, vectorial", "Vectorial, escalar", "Fundamental, derivada", "Derivada, fundamental"],
        answer: 1,
        explanation: "La velocidad es vectorial (indica mÃ³dulo, direcciÃ³n y sentido del cambio de posiciÃ³n). La rapidez es el mÃ³dulo de la velocidad, por lo tanto, es escalar.",
        difficulty: 'medium',
        topic: "Magnitudes FÃ­sicas"
    },
    {
        question: "Â¿CuÃ¡l de las siguientes opciones describe mejor una magnitud vectorial?",
        options: ["Solo tiene valor numÃ©rico", "Tiene valor numÃ©rico y unidad", "Tiene valor numÃ©rico, unidad y direcciÃ³n", "Es una constante universal"],
        answer: 2,
        explanation: "Una magnitud vectorial se caracteriza por tener un mÃ³dulo (valor numÃ©rico con unidad), una direcciÃ³n y un sentido.",
        difficulty: 'medium',
        topic: "Magnitudes FÃ­sicas"
    },
    {
        question: "La fuerza es una magnitud fÃ­sica de tipo:",
        options: ["Escalar y fundamental", "Vectorial y fundamental", "Escalar y derivada", "Vectorial y derivada"],
        answer: 3,
        explanation: "La fuerza es una magnitud vectorial (tiene magnitud, direcciÃ³n y sentido) y es derivada, ya que se define a partir de otras magnitudes (ej: $F=ma$, donde masa es fundamental y aceleraciÃ³n es derivada).",
        difficulty: 'medium',
        topic: "Magnitudes FÃ­sicas"
    },
    // --- Dificultad: DifÃ­cil ---
    {
        question: "La densidad, definida como masa por unidad de volumen ($\rho = m/V$), es una magnitud:",
        options: ["Fundamental y escalar", "Derivada y escalar", "Fundamental y vectorial", "Derivada y vectorial"],
        answer: 1,
        explanation: "La densidad se deriva de la masa (fundamental) y el volumen (derivado de longitud al cubo), y es una magnitud escalar, ya que no posee direcciÃ³n ni sentido.",
        difficulty: 'hard',
        topic: "Magnitudes FÃ­sicas"
    },
    {
        question: "El momento lineal (cantidad de movimiento), $p = mv$, es una magnitud:",
        options: ["Escalar", "Vectorial", "Adimensional", "Fundamental"],
        answer: 1,
        explanation: "El momento lineal es el producto de la masa (escalar) por la velocidad (vectorial), resultando en una magnitud vectorial con la misma direcciÃ³n y sentido que la velocidad.",
        difficulty: 'hard',
        topic: "Magnitudes FÃ­sicas"
    },
    {
        question: "El trabajo mecÃ¡nico, $W = \vec{F} \cdot \vec{d} = Fd \cos\theta$, a pesar de involucrar vectores fuerza y desplazamiento, es una magnitud:",
        options: ["Vectorial", "Escalar", "Fundamental", "Adimensional"],
        answer: 1,
        explanation: "El trabajo mecÃ¡nico es el producto escalar de la fuerza y el desplazamiento. El producto escalar de dos vectores da como resultado un escalar.",
        difficulty: 'hard',
        topic: "Magnitudes FÃ­sicas"
    },
    {
        question: "La intensidad de campo elÃ©ctrico, $\vec{E}$, es una magnitud:",
        options: ["Escalar", "Vectorial", "Fundamental", "Adimensional"],
        answer: 1,
        explanation: "La intensidad de campo elÃ©ctrico es una magnitud vectorial, ya que en cada punto del espacio tiene un mÃ³dulo, una direcciÃ³n y un sentido que indica la fuerza que actuarÃ­a sobre una carga de prueba positiva.",
        difficulty: 'hard',
        topic: "Magnitudes FÃ­sicas"
    },

    // ------------------------------------------------------------------------------------
    // TEMA: SISTEMA INTERNACIONAL DE MEDIDAS (SI)
    // ------------------------------------------------------------------------------------
    // --- Dificultad: FÃ¡cil ---
    {
        question: "En el Sistema Internacional (SI), la unidad de longitud es el:",
        options: ["Pie", "Metro", "Yarda", "Milla nÃ¡utica"],
        answer: 1,
        explanation: "El metro (sÃ­mbolo: m) es la unidad base de longitud en el Sistema Internacional de Unidades (SI).",
        difficulty: 'easy',
        topic: "SI"
    },
    {
        question: "La unidad de tiempo en el SI es el:",
        options: ["Minuto", "Hora", "Segundo", "DÃ­a"],
        answer: 2,
        explanation: "El segundo (sÃ­mbolo: s) es la unidad base de tiempo en el Sistema Internacional de Unidades (SI).",
        difficulty: 'easy',
        topic: "SI"
    },
    {
        question: "Â¿CuÃ¡l es la unidad de masa en el SI?",
        options: ["Gramo (g)", "Libra (lb)", "Kilogramo (kg)", "Tonelada (t)"],
        answer: 2,
        explanation: "El kilogramo (sÃ­mbolo: kg) es la unidad base de masa en el Sistema Internacional de Unidades (SI).",
        difficulty: 'easy',
        topic: "SI"
    },
    {
        question: "La unidad de intensidad de corriente elÃ©ctrica en el SI es el:",
        options: ["Voltio (V)", "Ohmio ($\Omega$)", "Amperio (A)", "Vatio (W)"],
        answer: 2,
        explanation: "El amperio (sÃ­mbolo: A), tambiÃ©n llamado ampere, es la unidad base de intensidad de corriente elÃ©ctrica en el SI.",
        difficulty: 'easy',
        topic: "SI"
    },
    // --- Dificultad: Medio ---
    {
        question: "El Newton (N), unidad de fuerza en el SI, se define como:",
        options: ["$kg \cdot m/s$", "$kg \cdot m^2/s$", "$kg \cdot m/s^2$", "$J/s$"],
        answer: 2,
        explanation: "Un Newton es la fuerza necesaria para proporcionar una aceleraciÃ³n de $1 m/s^2$ a un objeto cuya masa es de $1 kg$. Por la segunda ley de Newton ($F=ma$), sus unidades son $kg \cdot m/s^2$.",
        difficulty: 'medium',
        topic: "SI"
    },
    {
        question: "La unidad de energÃ­a o trabajo en el SI es el Joule (J). Â¿CuÃ¡l es su equivalencia en unidades fundamentales?",
        options: ["$kg \cdot m/s^2$", "$kg \cdot m^2/s^2$", "$kg \cdot m/s$", "$N/m$"],
        answer: 1,
        explanation: "Un Joule se define como el trabajo realizado cuando una fuerza de un Newton desplaza un objeto un metro en la direcciÃ³n de la fuerza. $J = N \cdot m = (kg \cdot m/s^2) \cdot m = kg \cdot m^2/s^2$.",
        difficulty: 'medium',
        topic: "SI"
    },
    {
        question: "La unidad de potencia en el SI es el Vatio (W). Se define como:",
        options: ["EnergÃ­a por unidad de tiempo ($J/s$)", "Fuerza por unidad de Ã¡rea ($N/m^2$)", "Carga por unidad de tiempo ($C/s$)", "Trabajo por unidad de carga ($J/C$)"],
        answer: 0,
        explanation: "La potencia es la rapidez con la que se realiza un trabajo o se transfiere energÃ­a. Un Vatio equivale a un Joule por segundo ($W = J/s$).",
        difficulty: 'medium',
        topic: "SI"
    },
    {
        question: "Â¿CuÃ¡l de las siguientes NO es una unidad fundamental del SI?",
        options: ["Kelvin (K)", "Mol (mol)", "Candela (cd)", "Voltio (V)"],
        answer: 3,
        explanation: "El Kelvin (temperatura), Mol (cantidad de sustancia) y Candela (intensidad luminosa) son unidades fundamentales del SI. El Voltio (diferencia de potencial elÃ©ctrico) es una unidad derivada ($V = J/C$).",
        difficulty: 'medium',
        topic: "SI"
    },
    // --- Dificultad: DifÃ­cil ---
    {
        question: "La unidad de presiÃ³n en el SI es el Pascal (Pa). Â¿CuÃ¡l es su equivalencia en unidades fundamentales?",
        options: ["$N/m^3$", "$kg / (m \cdot s^2)$", "$kg \cdot m^2 / s^3$", "$J/m^3$"],
        answer: 1,
        explanation: "PresiÃ³n es Fuerza por unidad de Ãrea. $P = F/A$. En unidades SI, $F$ es Newton ($kg \cdot m/s^2$) y $A$ es $m^2$. Entonces, $Pa = (kg \cdot m/s^2) / m^2 = kg / (m \cdot s^2)$.",
        difficulty: 'hard',
        topic: "SI"
    },
    {
        question: "La constante de gravitaciÃ³n universal G tiene unidades en el SI que se pueden expresar como:",
        options: ["$N \cdot m^2 / kg^2$", "$N \cdot kg^2 / m^2$", "$m^3 / (kg \cdot s^2)$", "Ambas A y C son correctas"],
        answer: 3,
        explanation: "De la ley de gravitaciÃ³n $F = G(m_1m_2)/r^2$, despejamos $G = Fr^2/(m_1m_2)$. Unidades: $N \cdot m^2 / kg^2$. Como $N = kg \cdot m/s^2$, sustituyendo: $(kg \cdot m/s^2) \cdot m^2 / kg^2 = m^3 / (kg \cdot s^2)$. Ambas expresiones son correctas.",
        difficulty: 'hard',
        topic: "SI"
    },
    {
        question: "La unidad de permitividad elÃ©ctrica del vacÃ­o, $\epsilon_0$, en el SI se puede expresar como Faradio por metro (F/m). Â¿CuÃ¡l es la expresiÃ³n del Faradio (F) en tÃ©rminos de unidades fundamentales del SI?",
        options: ["$s^4 \cdot A^2 / (kg \cdot m^2)$", "$kg \cdot m^2 / (s^2 \cdot A^2)$", "$s^2 \cdot A / (kg \cdot m)$", "$kg \cdot m / (s^3 \cdot A)$"],
        answer: 0,
        explanation: "Un Faradio es Coulomb por Voltio ($F=C/V$). $C = A \cdot s$. $V = J/C = (kg \cdot m^2/s^2) / (A \cdot s) = kg \cdot m^2 / (A \cdot s^3)$. Entonces $F = (A \cdot s) / (kg \cdot m^2 / (A \cdot s^3)) = A^2 \cdot s^4 / (kg \cdot m^2)$.",
        difficulty: 'hard',
        topic: "SI"
    },
    {
        question: "El Tesla (T), unidad de densidad de flujo magnÃ©tico en el SI, se puede expresar como:",
        options: ["$kg / (A \cdot s^2)$", "$N / (C \cdot m)$", "$V \cdot s / m^2$", "Todas las anteriores son correctas"],
        answer: 0, // De F = qvB, B = F/(qv). N / (C * m/s) = N*s / (C*m). Ns / (As * m) = N / (A*m). (kg*m/s^2)/(A*m) = kg/(A*s^2)
        explanation: "Un Tesla se define de varias maneras equivalentes. De la fuerza de Lorentz $F=qvB$, $B = F/(qv)$. Unidades: $N / (C \cdot m/s) = (N \cdot s) / (C \cdot m)$. Como $C = A \cdot s$, esto es $(N \cdot s) / (A \cdot s \cdot m) = N / (A \cdot m)$. Si $N = kg \cdot m/s^2$, entonces $T = (kg \cdot m/s^2) / (A \cdot m) = kg / (A \cdot s^2)$. TambiÃ©n $T = V \cdot s / m^2$ (de la ley de Faraday). La opciÃ³n A es la correcta en tÃ©rminos de $kg, A, s$.",
        difficulty: 'hard',
        topic: "SI"
    },


    // ------------------------------------------------------------------------------------
    // TEMA: PREFIJOS DEL SI
    // ------------------------------------------------------------------------------------
    // --- Dificultad: FÃ¡cil ---
    {
        question: "El prefijo 'kilo' (k) en el SI representa un factor de:",
        options: ["100", "1000", "0.01", "0.001"],
        answer: 1,
        explanation: "'kilo' (k) significa mil, es decir, un factor de $10^3$ o 1000. Ejemplo: 1 kilÃ³metro = 1000 metros.",
        difficulty: 'easy',
        topic: "Prefijos SI"
    },
    {
        question: "El prefijo 'mili' (m) representa un factor de:",
        options: ["$10^{-2}$ (centi)", "$10^{-3}$ (mili)", "$10^{-6}$ (micro)", "$10^{3}$ (kilo)"],
        answer: 1,
        explanation: "'mili' (m) significa la milÃ©sima parte, es decir, un factor de $10^{-3}$ o 0.001. Ejemplo: 1 mililitro = 0.001 litros.",
        difficulty: 'easy',
        topic: "Prefijos SI"
    },
    {
        question: "Â¿QuÃ© prefijo del SI significa $10^6$ (un millÃ³n)?",
        options: ["Mega (M)", "Kilo (k)", "Giga (G)", "Tera (T)"],
        answer: 0,
        explanation: "El prefijo 'Mega' (M) representa un factor de $10^6$ o un millÃ³n. Ejemplo: 1 Megavatio = 1,000,000 vatios.",
        difficulty: 'easy',
        topic: "Prefijos SI"
    },
    {
        question: "El prefijo 'centi' (c) equivale a:",
        options: ["$10^{-1}$", "$10^{-2}$", "$10^{-3}$", "$100$"],
        answer: 1,
        explanation: "'centi' (c) significa la centÃ©sima parte, es decir, un factor de $10^{-2}$ o 0.01. Ejemplo: 1 centÃ­metro = 0.01 metros.",
        difficulty: 'easy',
        topic: "Prefijos SI"
    },
    // --- Dificultad: Medio ---
    {
        question: "Un nanÃ³metro (nm) equivale a:",
        options: ["$10^{-3}$ metros (milÃ­metro)", "$10^{-6}$ metros (micrÃ³metro)", "$10^{-9}$ metros (nanÃ³metro)", "$10^{-12}$ metros (picÃ³metro)"],
        answer: 2,
        explanation: "El prefijo 'nano' (n) significa $10^{-9}$. Por lo tanto, 1 nanÃ³metro = $10^{-9}$ metros.",
        difficulty: 'medium',
        topic: "Prefijos SI"
    },
    {
        question: "Â¿CuÃ¡l es el sÃ­mbolo y factor del prefijo 'micro'?",
        options: ["m, $10^{-3}$", "$\mu$, $10^{-6}$", "n, $10^{-9}$", "p, $10^{-12}$"],
        answer: 1,
        explanation: "El prefijo 'micro' tiene el sÃ­mbolo $\mu$ (letra griega mu) y representa un factor de $10^{-6}$ (la millonÃ©sima parte).",
        difficulty: 'medium',
        topic: "Prefijos SI"
    },
    {
        question: "Si una memoria USB tiene una capacidad de 64 Gigabytes (GB), Â¿cuÃ¡ntos bytes son aproximadamente? (Considera $1 GB = 10^9 B$)",
        options: ["$64 \times 10^3$ bytes", "$64 \times 10^6$ bytes", "$64 \times 10^9$ bytes", "$64 \times 10^{12}$ bytes"],
        answer: 2,
        explanation: "El prefijo 'Giga' (G) representa $10^9$. Por lo tanto, 64 GB = $64 \times 10^9$ bytes.",
        difficulty: 'medium',
        topic: "Prefijos SI"
    },
    {
        question: "Convertir 0.052 kilogramos (kg) a miligramos (mg).",
        options: ["52 mg", "520 mg", "5200 mg", "52000 mg"],
        answer: 3,
        explanation: "$0.052 \text{ kg} = 0.052 \times 1000 \text{ g} = 52 \text{ g}$. Luego, $52 \text{ g} = 52 \times 1000 \text{ mg} = 52000 \text{ mg}$. O directamente: $0.052 \text{ kg} \times (10^6 \text{ mg} / 1 \text{ kg}) = 52000 \text{ mg}$.",
        difficulty: 'medium',
        topic: "Prefijos SI"
    },
    // --- Dificultad: DifÃ­cil ---
    {
        question: "Â¿CuÃ¡ntos picosegundos (ps) hay en un microsegundo ($\mu s$)?",
        options: ["$10^3$", "$10^6$", "$10^9$", "$10^{-6}$"],
        answer: 1,
        explanation: "1 $\mu s = 10^{-6} s$. 1 $ps = 10^{-12} s$. Para convertir $\mu s$ a $ps$, dividimos el factor de micro por el factor de pico: $10^{-6} / 10^{-12} = 10^{-6 - (-12)} = 10^{6}$. Hay $10^6$ picosegundos en 1 microsegundo.",
        difficulty: 'hard',
        topic: "Prefijos SI"
    },
    {
        question: "La frecuencia de una onda de radio es de 300 MHz (MegaHertz). Expresar esta frecuencia en GigaHertz (GHz).",
        options: ["0.03 GHz", "0.3 GHz", "3 GHz", "30 GHz"],
        answer: 1,
        explanation: "Mega (M) es $10^6$ y Giga (G) es $10^9$. $300 \text{ MHz} = 300 \times 10^6 \text{ Hz}$. Para convertir a GHz, dividimos por $10^9$: $(300 \times 10^6) / 10^9 = 300 \times 10^{-3} = 0.3 \text{ GHz}$.",
        difficulty: 'hard',
        topic: "Prefijos SI"
    },
    {
        question: "Un condensador tiene una capacidad de 2500 picofaradios (pF). Â¿CuÃ¡l es su capacidad en microfaradios ($\mu F$)?",
        options: ["$2.5 \times 10^{-3} \mu F$", "$0.025 \mu F$", "$0.25 \mu F$", "$2.5 \mu F$"],
        answer: 0,
        explanation: "Pico (p) es $10^{-12}$ y Micro ($\mu$) es $10^{-6}$. $2500 \text{ pF} = 2500 \times 10^{-12} \text{ F}$. Para convertir a $\mu F$, dividimos por $10^{-6}$: $(2500 \times 10^{-12}) / 10^{-6} = 2500 \times 10^{-6} \mu F = 2.5 \times 10^3 \times 10^{-6} \mu F = 2.5 \times 10^{-3} \mu F$.",
        difficulty: 'hard',
        topic: "Prefijos SI"
    },
    {
        question: "La longitud de onda de cierta luz es 0.55 micrÃ³metros ($\mu m$). Â¿CuÃ¡ntos Angstroms ($\AA$) son, sabiendo que $1 \AA = 10^{-10} m$?",
        options: ["$5.5 \AA$", "$55 \AA$", "$550 \AA$", "$5500 \AA$"],
        answer: 3,
        explanation: "$0.55 \mu m = 0.55 \times 10^{-6} m$. Para convertir a Angstroms, dividimos por $10^{-10} m/\AA$: $(0.55 \times 10^{-6} m) / (10^{-10} m/\AA) = 0.55 \times 10^4 \AA = 5500 \AA$.",
        difficulty: 'hard',
        topic: "Prefijos SI"
    },

    // ------------------------------------------------------------------------------------
    // TEMA: CINEMÃTICA (Conceptos Generales)
    // ------------------------------------------------------------------------------------
    // --- Dificultad: FÃ¡cil ---
    {
        question: "Â¿QuÃ© estudia la cinemÃ¡tica?",
        options: ["Las causas que originan el movimiento", "El movimiento de los cuerpos sin atender a las causas que lo producen", "Las fuerzas y el equilibrio estÃ¡tico de los cuerpos", "La energÃ­a asociada al movimiento y a la posiciÃ³n"],
        answer: 1,
        explanation: "La cinemÃ¡tica es la rama de la mecÃ¡nica que describe el movimiento de los objetos sÃ³lidos sin considerar las causas (fuerzas) que lo originan; se limita principalmente al estudio de la trayectoria en funciÃ³n del tiempo.",
        difficulty: 'easy',
        topic: "CinemÃ¡tica"
    },
    {
        question: "Un punto material o partÃ­cula en fÃ­sica es un objeto que...",
        options: ["Tiene masa pero no volumen", "Tiene dimensiones despreciables en comparaciÃ³n con las distancias analizadas", "No tiene masa ni volumen", "Siempre se mueve en lÃ­nea recta"],
        answer: 1,
        explanation: "En cinemÃ¡tica, a menudo se modela un objeto como una partÃ­cula o punto material si sus dimensiones son irrelevantes para la descripciÃ³n de su movimiento.",
        difficulty: 'easy',
        topic: "CinemÃ¡tica"
    },
    {
        question: "El concepto de 'posiciÃ³n' de un mÃ³vil requiere especificar un...",
        options: ["Sistema de referencia", "Intervalo de tiempo", "Tipo de fuerza aplicada", "Valor de su masa"],
        answer: 0,
        explanation: "La posiciÃ³n de un objeto se define siempre con respecto a un sistema de referencia o coordenado.",
        difficulty: 'easy',
        topic: "CinemÃ¡tica"
    },
    {
        question: "La 'distancia recorrida' por un mÃ³vil es siempre:",
        options: ["Igual al mÃ³dulo del desplazamiento", "Una magnitud vectorial", "Una cantidad positiva o cero", "Menor o igual al mÃ³dulo del desplazamiento"],
        answer: 2,
        explanation: "La distancia recorrida es la longitud total del camino seguido por el mÃ³vil, por lo que siempre es una cantidad positiva o cero. Puede ser mayor que el mÃ³dulo del desplazamiento si la trayectoria no es recta.",
        difficulty: 'easy',
        topic: "CinemÃ¡tica"
    },
    // --- Dificultad: Medio ---
    {
        question: "La trayectoria de un mÃ³vil es:",
        options: ["Siempre una lÃ­nea recta", "La distancia total recorrida entre dos puntos", "El camino o lÃ­nea geomÃ©trica que describe al moverse", "Su velocidad instantÃ¡nea en cada punto"],
        answer: 2,
        explanation: "La trayectoria es la curva que une las sucesivas posiciones ocupadas por un mÃ³vil a lo largo del tiempo.",
        difficulty: 'medium',
        topic: "CinemÃ¡tica"
    },
    {
        question: "La velocidad media se define como:",
        options: ["La distancia recorrida dividida por el tiempo empleado", "El desplazamiento dividido por el intervalo de tiempo", "El promedio de las velocidades instantÃ¡neas", "La rapidez en un instante especÃ­fico"],
        answer: 1,
        explanation: "La velocidad media es una magnitud vectorial definida como el cociente entre el vector desplazamiento ($\Delta\vec{r}$) y el intervalo de tiempo ($\Delta t$) empleado en realizarlo: $\vec{v}_m = \Delta\vec{r} / \Delta t$.",
        difficulty: 'medium',
        topic: "CinemÃ¡tica"
    },
    {
        question: "Si un coche da una vuelta completa a una pista circular de radio R y vuelve al punto de partida, su desplazamiento es:",
        options: ["$2\pi R$", "$0$", "$\pi R$", "Depende de su velocidad"],
        answer: 1,
        explanation: "El desplazamiento es el vector que une la posiciÃ³n inicial con la final. Si el punto inicial y final coinciden, el vector desplazamiento es nulo (cero).",
        difficulty: 'medium',
        topic: "CinemÃ¡tica"
    },
    {
        question: "La aceleraciÃ³n instantÃ¡nea mide:",
        options: ["El cambio de posiciÃ³n por unidad de tiempo", "La rapidez con la que cambia la velocidad en un instante", "La distancia total recorrida", "La velocidad media en un intervalo muy pequeÃ±o"],
        answer: 1,
        explanation: "La aceleraciÃ³n instantÃ¡nea es el lÃ­mite de la aceleraciÃ³n media cuando el intervalo de tiempo tiende a cero, representando cÃ³mo cambia la velocidad en un instante dado. Es la derivada de la velocidad respecto al tiempo.",
        difficulty: 'medium',
        topic: "CinemÃ¡tica"
    },
    // --- Dificultad: DifÃ­cil ---
    {
        question: "Un objeto se mueve de $x_1 = 2m$ a $x_2 = -3m$. Â¿CuÃ¡l es su desplazamiento $\Delta x$ y la distancia recorrida si el movimiento fue siempre en la misma direcciÃ³n (sin retroceder)?",
        options: ["$\Delta x = -5m$, dist = $5m$", "$\Delta x = 5m$, dist = $5m$", "$\Delta x = -1m$, dist = $1m$", "$\Delta x = -5m$, dist = $1m$"],
        answer: 0,
        explanation: "Desplazamiento $\Delta x = x_2 - x_1 = -3m - 2m = -5m$. Si no retrocediÃ³, la distancia recorrida es el valor absoluto del desplazamiento, $|-5m| = 5m$.",
        difficulty: 'hard',
        topic: "CinemÃ¡tica"
    },
    {
        question: "Si la velocidad de un cuerpo es constante y no nula, su aceleraciÃ³n es:",
        options: ["Constante y no nula", "Variable", "Nula", "Igual a la velocidad"],
        answer: 2,
        explanation: "La aceleraciÃ³n se define como el cambio de la velocidad en el tiempo. Si la velocidad es constante (tanto en mÃ³dulo como en direcciÃ³n), no hay cambio, por lo tanto, la aceleraciÃ³n es nula.",
        difficulty: 'hard',
        topic: "CinemÃ¡tica"
    },
    {
        question: "La ecuaciÃ³n de posiciÃ³n de un mÃ³vil es $x(t) = 2t^3 - 5t^2 + 3t - 1$ (en unidades SI). Â¿CuÃ¡l es su aceleraciÃ³n en $t=2s$?",
        options: ["$12 m/s^2$", "$14 m/s^2$", "$24 m/s^2$", "$10 m/s^2$"],
        answer: 1,
        explanation: "Para hallar la aceleraciÃ³n, derivamos dos veces la posiciÃ³n respecto al tiempo. $v(t) = dx/dt = 6t^2 - 10t + 3$. $a(t) = dv/dt = 12t - 10$. En $t=2s$, $a(2) = 12(2) - 10 = 24 - 10 = 14 m/s^2$.",
        difficulty: 'hard',
        topic: "CinemÃ¡tica"
    },
    {
        question: "Â¿Puede un cuerpo tener velocidad cero en un instante y aun asÃ­ estar acelerado?",
        options: ["No, si la velocidad es cero, la aceleraciÃ³n tambiÃ©n lo es.", "SÃ­, por ejemplo, en el punto mÃ¡s alto de un lanzamiento vertical.", "Solo si la masa es muy grande.", "Solo en el vacÃ­o."],
        answer: 1,
        explanation: "SÃ­. Un ejemplo clÃ¡sico es un objeto lanzado verticalmente hacia arriba: en el punto mÃ¡s alto de su trayectoria, su velocidad instantÃ¡nea es cero, pero sigue sometido a la aceleraciÃ³n de la gravedad.",
        difficulty: 'hard',
        topic: "CinemÃ¡tica"
    },

    // ------------------------------------------------------------------------------------
    // TEMA: MOVIMIENTO RECTILÃNEO UNIFORME (MRU)
    // ------------------------------------------------------------------------------------
    // --- Dificultad: FÃ¡cil ---
    {
        question: "En un Movimiento RectilÃ­neo Uniforme (MRU), la velocidad del mÃ³vil es...",
        options: ["Constante", "Cero", "Variable y aumenta linealmente", "Variable y disminuye linealmente"],
        answer: 0,
        explanation: "La caracterÃ­stica principal del MRU es que la velocidad es constante en magnitud, direcciÃ³n y sentido. Esto implica que la aceleraciÃ³n es nula.",
        difficulty: 'easy',
        topic: "MRU"
    },
    {
        question: "La ecuaciÃ³n que describe la posiciÃ³n $x$ en funciÃ³n del tiempo $t$ para un MRU es:",
        options: ["$x(t) = v_0 t + (1/2)at^2$", "$x(t) = x_0 + vt$", "$x(t) = x_0 + v_0t + (1/2)at^2$", "$v(t) = v_0 + at$"],
        answer: 1,
        explanation: "En un MRU, la posiciÃ³n final es igual a la posiciÃ³n inicial mÃ¡s el producto de la velocidad constante por el tiempo transcurrido: $x(t) = x_0 + vt$.",
        difficulty: 'easy',
        topic: "MRU"
    },
    {
        question: "Si un coche se mueve con MRU a $20 m/s$ durante $5 s$, Â¿quÃ© distancia recorre?",
        options: ["$4 m$", "$25 m$", "$100 m$", "$500 m$"],
        answer: 2,
        explanation: "En MRU, distancia = velocidad Ã— tiempo. $d = (20 m/s) \times (5 s) = 100 m$.",
        difficulty: 'easy',
        topic: "MRU"
    },
    {
        question: "La grÃ¡fica de posiciÃ³n contra tiempo ($x$ vs $t$) para un MRU es una:",
        options: ["ParÃ¡bola", "LÃ­nea recta horizontal", "LÃ­nea recta con pendiente constante", "Curva exponencial"],
        answer: 2,
        explanation: "Dado que $x(t) = x_0 + vt$, la relaciÃ³n entre $x$ y $t$ es lineal. La pendiente de esta recta representa la velocidad constante.",
        difficulty: 'easy',
        topic: "MRU"
    },
    // --- Dificultad: Medio ---
    {
        question: "Un coche viaja a 72 km/h (MRU). Â¿QuÃ© distancia recorre en 10 segundos?",
        options: ["720 m", "200 m", "20 m", "7.2 m"],
        answer: 1,
        explanation: "Primero, convertimos la velocidad a m/s: $72 \text{ km/h} = 72 \times (1000 \text{ m} / 1 \text{ km}) \times (1 \text{ h} / 3600 \text{ s}) = 20 \text{ m/s}$. Luego, distancia $d = v \cdot t = (20 \text{ m/s}) \cdot (10 \text{ s}) = 200 \text{ m}$.",
        difficulty: 'medium',
        topic: "MRU"
    },
    {
        question: "Un tren recorre $300 km$ en $2.5$ horas con MRU. Â¿CuÃ¡l es su velocidad en km/h?",
        options: ["75 km/h", "100 km/h", "120 km/h", "150 km/h"],
        answer: 2,
        explanation: "Velocidad $v = d/t = 300 \text{ km} / 2.5 \text{ h} = 120 \text{ km/h}$.",
        difficulty: 'medium',
        topic: "MRU"
    },
    {
        question: "Dos mÃ³viles A y B parten del mismo punto y se mueven en la misma direcciÃ³n con MRU. Si $v_A = 10 m/s$ y $v_B = 15 m/s$, Â¿cuÃ¡l es la distancia que los separa despuÃ©s de 20 segundos?",
        options: ["50 m", "100 m", "200 m", "300 m"],
        answer: 1,
        explanation: "Distancia de A: $d_A = 10 m/s \times 20 s = 200 m$. Distancia de B: $d_B = 15 m/s \times 20 s = 300 m$. La separaciÃ³n es $d_B - d_A = 300 m - 200 m = 100 m$.",
        difficulty: 'medium',
        topic: "MRU"
    },
    {
        question: "La grÃ¡fica de velocidad contra tiempo ($v$ vs $t$) para un MRU es una:",
        options: ["LÃ­nea recta con pendiente positiva", "LÃ­nea recta horizontal", "LÃ­nea recta con pendiente negativa", "ParÃ¡bola"],
        answer: 1,
        explanation: "En un MRU, la velocidad es constante, por lo que su representaciÃ³n grÃ¡fica frente al tiempo es una lÃ­nea recta horizontal (pendiente cero).",
        difficulty: 'medium',
        topic: "MRU"
    },
    // --- Dificultad: DifÃ­cil ---
    {
        question: "Dos trenes parten de dos ciudades A y B distantes 300 km, uno hacia el otro. El de A va a 60 km/h y el de B a 40 km/h. Â¿CuÃ¡nto tardan en encontrarse si parten simultÃ¡neamente?",
        options: ["2 horas", "2.5 horas", "3 horas", "5 horas"],
        answer: 2,
        explanation: "La velocidad relativa de acercamiento es la suma de sus velocidades: $v_{rel} = 60 \text{ km/h} + 40 \text{ km/h} = 100 \text{ km/h}$. El tiempo de encuentro es $t = d / v_{rel} = 300 \text{ km} / 100 \text{ km/h} = 3 \text{ horas}$.",
        difficulty: 'hard',
        topic: "MRU"
    },
    {
        question: "Un coche parte del reposo y se mueve con MRU a $15 m/s$. Otro coche, que estÃ¡ $60 m$ adelante, parte en el mismo instante y en la misma direcciÃ³n con MRU a $10 m/s$. Â¿En quÃ© instante alcanzarÃ¡ el primer coche al segundo?",
        options: ["6 s", "8 s", "10 s", "12 s"],
        answer: 3,
        explanation: "Sea $t$ el tiempo de alcance. PosiciÃ³n del primer coche: $x_1 = 15t$. PosiciÃ³n del segundo coche: $x_2 = 60 + 10t$. En el alcance, $x_1 = x_2 \Rightarrow 15t = 60 + 10t \Rightarrow 5t = 60 \Rightarrow t = 12 s$.",
        difficulty: 'hard',
        topic: "MRU"
    },
    {
        question: "Un rÃ­o fluye a $3 m/s$. Un bote cruza el rÃ­o perpendicularmente a la corriente con una velocidad relativa al agua de $4 m/s$. Si el ancho del rÃ­o es de $120 m$, Â¿cuÃ¡nto tiempo tarda el bote en cruzar?",
        options: ["24 s", "30 s", "40 s", "50 s"],
        answer: 1,
        explanation: "El tiempo para cruzar el rÃ­o depende solo de la componente de la velocidad del bote perpendicular a la corriente y del ancho del rÃ­o. $t = \text{ancho} / v_{\text{bote_perp}} = 120 m / 4 m/s = 30 s$. La velocidad de la corriente afecta dÃ³nde llega en la otra orilla, pero no el tiempo de cruce.",
        difficulty: 'hard',
        topic: "MRU"
    },
    {
        question: "La posiciÃ³n de una partÃ­cula que se mueve con MRU estÃ¡ dada por $x(t) = 5 - 2t$ (en metros, $t$ en segundos). Â¿CuÃ¡l es su velocidad y su posiciÃ³n inicial?",
        options: ["$v = 5 m/s, x_0 = -2 m$", "$v = -2 m/s, x_0 = 5 m$", "$v = 2 m/s, x_0 = 5 m$", "$v = -5 m/s, x_0 = 2 m$"],
        answer: 1,
        explanation: "La ecuaciÃ³n general del MRU es $x(t) = x_0 + vt$. Comparando con $x(t) = 5 - 2t$, identificamos que la posiciÃ³n inicial $x_0 = 5 m$ y la velocidad constante $v = -2 m/s$.",
        difficulty: 'hard',
        topic: "MRU"
    },


    // ------------------------------------------------------------------------------------
    // TEMA: MOVIMIENTO RECTILÃNEO UNIFORMEMENTE ACELERADO (MRUA)
    // ------------------------------------------------------------------------------------
    // --- Dificultad: FÃ¡cil ---
    {
        question: "En un Movimiento RectilÃ­neo Uniformemente Acelerado (MRUA), la aceleraciÃ³n es...",
        options: ["Nula", "Constante y no nula", "Variable, aumentando con el tiempo", "Variable, disminuyendo con el tiempo"],
        answer: 1,
        explanation: "La caracterÃ­stica principal del MRUA es que la aceleraciÃ³n es constante y diferente de cero. Esto significa que la velocidad cambia a un ritmo constante.",
        difficulty: 'easy',
        topic: "MRUA"
    },
    {
        question: "Si un objeto en MRUA parte del reposo, su velocidad despuÃ©s de un tiempo $t$ es:",
        options: ["$v_f = at$", "$v_f = v_0 - at$", "$v_f = (1/2)at^2$", "$v_f = a/t$"],
        answer: 0,
        explanation: "La ecuaciÃ³n de velocidad en MRUA es $v_f = v_0 + at$. Si parte del reposo, $v_0 = 0$, entonces $v_f = at$.",
        difficulty: 'easy',
        topic: "MRUA"
    },
    {
        question: "La grÃ¡fica de velocidad contra tiempo ($v$ vs $t$) para un MRUA es una:",
        options: ["LÃ­nea recta horizontal", "ParÃ¡bola", "LÃ­nea recta con pendiente constante (no necesariamente cero)", "HipÃ©rbola"],
        answer: 2,
        explanation: "Dado que $v(t) = v_0 + at$, la relaciÃ³n entre $v$ y $t$ es lineal. La pendiente de esta recta representa la aceleraciÃ³n constante.",
        difficulty: 'easy',
        topic: "MRUA"
    },
    {
        question: "Si la aceleraciÃ³n de un mÃ³vil es positiva y su velocidad inicial es positiva, el mÃ³vil estÃ¡:",
        options: ["Frenando", "MoviÃ©ndose con velocidad constante", "Acelerando (aumentando su rapidez)", "En reposo"],
        answer: 2,
        explanation: "Si la aceleraciÃ³n y la velocidad tienen el mismo signo, el mÃ³dulo de la velocidad (rapidez) aumenta, es decir, el mÃ³vil acelera.",
        difficulty: 'easy',
        topic: "MRUA"
    },
    // --- Dificultad: Medio ---
    {
        question: "Un objeto parte del reposo con una aceleraciÃ³n constante de $2 m/s^2$. Â¿QuÃ© velocidad tendrÃ¡ despuÃ©s de 5 segundos?",
        options: ["$2 m/s$", "$5 m/s$", "$10 m/s$", "$25 m/s$"],
        answer: 2,
        explanation: "Usamos la ecuaciÃ³n $v_f = v_0 + at$. Como $v_0=0$ (parte del reposo), $a = 2 m/s^2$ y $t = 5 s$, entonces $v_f = (0) + (2 m/s^2)(5 s) = 10 m/s$.",
        difficulty: 'medium',
        topic: "MRUA"
    },
    {
        question: "Un coche acelera de $10 m/s$ a $30 m/s$ en $4 s$. Â¿CuÃ¡l es su aceleraciÃ³n media?",
        options: ["$2.5 m/s^2$", "$5 m/s^2$", "$7.5 m/s^2$", "$10 m/s^2$"],
        answer: 1,
        explanation: "AceleraciÃ³n $a = (v_f - v_0) / t = (30 m/s - 10 m/s) / 4 s = 20 m/s / 4 s = 5 m/s^2$.",
        difficulty: 'medium',
        topic: "MRUA"
    },
    {
        question: "Un mÃ³vil parte del reposo y acelera a $3 m/s^2$. Â¿QuÃ© distancia recorre en los primeros 4 segundos?",
        options: ["$6 m$", "$12 m$", "$18 m$", "$24 m$"],
        answer: 3,
        explanation: "Usamos $x = v_0t + (1/2)at^2$. Con $v_0=0$, $x = (1/2)(3 m/s^2)(4 s)^2 = (1/2)(3)(16) = 24 m$.",
        difficulty: 'medium',
        topic: "MRUA"
    },
    {
        question: "La grÃ¡fica de posiciÃ³n contra tiempo ($x$ vs $t$) para un MRUA es una:",
        options: ["LÃ­nea recta", "ParÃ¡bola", "HipÃ©rbola", "Exponencial"],
        answer: 1,
        explanation: "La ecuaciÃ³n de posiciÃ³n en MRUA es $x(t) = x_0 + v_0t + (1/2)at^2$, que es una ecuaciÃ³n cuadrÃ¡tica en $t$. Su representaciÃ³n grÃ¡fica es una parÃ¡bola.",
        difficulty: 'medium',
        topic: "MRUA"
    },
    // --- Dificultad: DifÃ­cil ---
    {
        question: "Un coche que viaja a $20 m/s$ frena uniformemente hasta detenerse en $50 m$. Â¿CuÃ¡l fue su aceleraciÃ³n (desaceleraciÃ³n)?",
        options: ["$-2 m/s^2$", "$-4 m/s^2$", "$-5 m/s^2$", "$-8 m/s^2$"],
        answer: 1,
        explanation: "Usamos la ecuaciÃ³n $v_f^2 = v_0^2 + 2ad$. AquÃ­ $v_f=0$ (se detiene), $v_0=20 m/s$, $d=50 m$. Entonces, $0^2 = (20 m/s)^2 + 2a(50 m) \Rightarrow 0 = 400 + 100a \Rightarrow 100a = -400 \Rightarrow a = -4 m/s^2$.",
        difficulty: 'hard',
        topic: "MRUA"
    },
    {
        question: "Un objeto se mueve con una aceleraciÃ³n constante. Si su velocidad cambia de $5 m/s$ a $15 m/s$ mientras recorre $25 m$, Â¿cuÃ¡l es el valor de su aceleraciÃ³n?",
        options: ["$2 m/s^2$", "$3 m/s^2$", "$4 m/s^2$", "$5 m/s^2$"],
        answer: 2,
        explanation: "Usamos $v_f^2 = v_0^2 + 2ad$. $(15)^2 = (5)^2 + 2a(25) \Rightarrow 225 = 25 + 50a \Rightarrow 200 = 50a \Rightarrow a = 4 m/s^2$.",
        difficulty: 'hard',
        topic: "MRUA"
    },
    {
        question: "Un tren parte del reposo y acelera uniformemente. En el quinto segundo de su movimiento recorre $9 m$. Â¿CuÃ¡l es su aceleraciÃ³n?",
        options: ["$1 m/s^2$", "$1.5 m/s^2$", "$2 m/s^2$", "$2.5 m/s^2$"],
        answer: 2,
        explanation: "Distancia en el n-Ã©simo segundo: $d_n = v_0 + a(n - 1/2)$. AquÃ­ $v_0=0$, $n=5$, $d_5=9m$. $9 = 0 + a(5 - 0.5) \Rightarrow 9 = a(4.5) \Rightarrow a = 9/4.5 = 2 m/s^2$.",
        difficulty: 'hard',
        topic: "MRUA"
    },
    {
        question: "La velocidad de una partÃ­cula estÃ¡ dada por $v(t) = (12 - 4t) m/s$. Si en $t=0$, $x=0$, Â¿cuÃ¡l es su posiciÃ³n en $t=5s$?",
        options: ["$10 m$", "$15 m$", "$20 m$", "$25 m$"],
        answer: 0,
        explanation: "La posiciÃ³n es la integral de la velocidad: $x(t) = \int v(t)dt = \int (12 - 4t)dt = 12t - 2t^2 + C$. Como $x(0)=0$, entonces $C=0$. AsÃ­, $x(t) = 12t - 2t^2$. En $t=5s$, $x(5) = 12(5) - 2(5)^2 = 60 - 2(25) = 60 - 50 = 10 m$.",
        difficulty: 'hard',
        topic: "MRUA"
    },

    // ------------------------------------------------------------------------------------
    // TEMA: MOVIMIENTO VERTICAL CON GRAVEDAD (CaÃ­da Libre y Lanzamiento Vertical)
    // ------------------------------------------------------------------------------------
    // --- Dificultad: FÃ¡cil ---
    {
        question: "En ausencia de resistencia del aire, todos los objetos en caÃ­da libre cerca de la superficie terrestre caen con la misma...",
        options: ["Velocidad inicial", "AceleraciÃ³n (g)", "Distancia en el primer segundo", "Masa"],
        answer: 1,
        explanation: "En caÃ­da libre ideal (sin resistencia del aire), la aceleraciÃ³n debida a la gravedad (g) es constante para todos los objetos, independientemente de su masa. Su valor aproximado es $9.8 m/s^2$ (o $10 m/s^2$ para simplificar).",
        difficulty: 'easy',
        topic: "Vertical"
    },
    {
        question: "Cuando un objeto se lanza verticalmente hacia arriba, en el punto mÃ¡s alto de su trayectoria, su velocidad instantÃ¡nea es:",
        options: ["MÃ¡xima", "Cero", "Igual a g", "Constante"],
        answer: 1,
        explanation: "En el punto mÃ¡s alto de un lanzamiento vertical, el objeto momentÃ¡neamente deja de subir antes de empezar a caer. En ese instante, su velocidad vertical es cero.",
        difficulty: 'easy',
        topic: "Vertical"
    },
    {
        question: "Si se deja caer un objeto desde el reposo, su velocidad despuÃ©s de 1 segundo de caÃ­da (usando $g \approx 10 m/s^2$) es aproximadamente:",
        options: ["$5 m/s$", "$10 m/s$", "$15 m/s$", "$20 m/s$"],
        answer: 1,
        explanation: "En caÃ­da libre, $v_f = v_0 + gt$. Si $v_0=0$, entonces $v_f = gt = (10 m/s^2)(1 s) = 10 m/s$.",
        difficulty: 'easy',
        topic: "Vertical"
    },
    {
        question: "La aceleraciÃ³n de un objeto en caÃ­da libre (despreciando la resistencia del aire) es:",
        options: ["Positiva hacia arriba", "Negativa hacia abajo (si se toma eje Y positivo hacia arriba)", "Cero", "Dependiente de la masa del objeto"],
        answer: 1,
        explanation: "La aceleraciÃ³n de la gravedad siempre actÃºa hacia abajo. Si se define el eje Y positivo hacia arriba, entonces $g$ se considera negativa (aprox. $-9.8 m/s^2$).",
        difficulty: 'easy',
        topic: "Vertical"
    },
    // --- Dificultad: Medio ---
    {
        question: "Se deja caer un objeto desde una altura de $20 m$. Â¿CuÃ¡nto tiempo tarda en llegar al suelo? (Usar $g \approx 10 m/s^2$)",
        options: ["1 s", "$\sqrt{2}$ s ($\approx 1.41 s$)", "2 s", "4 s"],
        answer: 2,
        explanation: "Usamos la ecuaciÃ³n de posiciÃ³n para caÃ­da libre: $h = v_0t + (1/2)gt^2$. Como parte del reposo, $v_0=0$. Entonces, $20 m = (1/2)(10 m/s^2)t^2 \Rightarrow 20 = 5t^2 \Rightarrow t^2 = 4 \Rightarrow t = 2 s$.",
        difficulty: 'medium',
        topic: "Vertical"
    },
    {
        question: "Un objeto es lanzado verticalmente hacia arriba con una velocidad inicial de $30 m/s$. Â¿CuÃ¡nto tiempo tarda en alcanzar su altura mÃ¡xima? (Usar $g \approx 10 m/s^2$)",
        options: ["1.5 s", "2 s", "3 s", "6 s"],
        answer: 2,
        explanation: "En la altura mÃ¡xima, la velocidad final $v_f = 0$. Usamos $v_f = v_0 - gt \Rightarrow 0 = 30 m/s - (10 m/s^2)t \Rightarrow 10t = 30 \Rightarrow t = 3 s$.",
        difficulty: 'medium',
        topic: "Vertical"
    },
    {
        question: "Desde lo alto de un edificio se lanza una piedra verticalmente hacia abajo con una velocidad de $5 m/s$. Si llega al suelo en $3 s$, Â¿cuÃ¡l es la altura del edificio? (Usar $g \approx 10 m/s^2$)",
        options: ["$45 m$", "$50 m$", "$60 m$", "$75 m$"],
        answer: 2,
        explanation: "Usamos $h = v_0t + (1/2)gt^2$. $h = (5 m/s)(3 s) + (1/2)(10 m/s^2)(3 s)^2 = 15 m + (1/2)(10)(9) m = 15 m + 45 m = 60 m$.",
        difficulty: 'medium',
        topic: "Vertical"
    },
    {
        question: "Si un objeto tarda 4 segundos en caer libremente desde el reposo, Â¿con quÃ© velocidad impacta el suelo? (Usar $g \approx 10 m/s^2$)",
        options: ["$20 m/s$", "$30 m/s$", "$40 m/s$", "$80 m/s$"],
        answer: 2,
        explanation: "$v_f = v_0 + gt$. Con $v_0=0$, $v_f = (10 m/s^2)(4 s) = 40 m/s$.",
        difficulty: 'medium',
        topic: "Vertical"
    },
    // --- Dificultad: DifÃ­cil ---
    {
        question: "Se lanza una pelota verticalmente hacia arriba con $30 m/s$. Â¿QuÃ© altura mÃ¡xima alcanza? (Usar $g \approx 10 m/s^2$)",
        options: ["15 m", "30 m", "45 m", "90 m"],
        answer: 2,
        explanation: "En la altura mÃ¡xima, $v_f=0$. Usamos la ecuaciÃ³n $v_f^2 = v_0^2 - 2gh$ (tomando g positiva y el signo menos por la direcciÃ³n). $0^2 = (30 m/s)^2 - 2(10 m/s^2)h \Rightarrow 0 = 900 - 20h \Rightarrow 20h = 900 \Rightarrow h = 45 m$.",
        difficulty: 'hard',
        topic: "Vertical"
    },
    {
        question: "Un objeto se deja caer desde una altura H. Tarda un tiempo T en llegar al suelo. Â¿Desde quÃ© altura se deberÃ­a dejar caer para que tarde 2T en llegar al suelo?",
        options: ["$\sqrt{2}H$", "$2H$", "$4H$", "$H/2$"],
        answer: 2,
        explanation: "Para caÃ­da libre, $H = (1/2)gT^2$. Si el tiempo es $2T$, la nueva altura $H' = (1/2)g(2T)^2 = (1/2)g(4T^2) = 4 \times [(1/2)gT^2] = 4H$.",
        difficulty: 'hard',
        topic: "Vertical"
    },
    {
        question: "Se lanza un cuerpo verticalmente hacia arriba. Si su altura mÃ¡xima es de $20 m$, Â¿con quÃ© velocidad inicial fue lanzado? (Usar $g \approx 10 m/s^2$)",
        options: ["$10 m/s$", "$14.14 m/s$", "$20 m/s$", "$40 m/s$"],
        answer: 2,
        explanation: "En altura mÃ¡xima $v_f=0$. $v_f^2 = v_0^2 - 2gh \Rightarrow 0 = v_0^2 - 2(10)(20) \Rightarrow v_0^2 = 400 \Rightarrow v_0 = \sqrt{400} = 20 m/s$.",
        difficulty: 'hard',
        topic: "Vertical"
    },
    {
        question: "Desde un globo que asciende verticalmente con una velocidad constante de $5 m/s$, se deja caer un objeto cuando el globo estÃ¡ a $30 m$ de altura. Â¿CuÃ¡nto tiempo tarda el objeto en llegar al suelo? (Usar $g \approx 10 m/s^2$)",
        options: ["2 s", "2.5 s", "3 s", "3.5 s"],
        answer: 2,
        explanation: "La velocidad inicial del objeto es $v_0 = +5 m/s$ (hacia arriba). Usamos $y_f = y_0 + v_0t - (1/2)gt^2$. Tomando $y_f=0$ (suelo) y $y_0=30m$: $0 = 30 + 5t - (1/2)(10)t^2 \Rightarrow 0 = 30 + 5t - 5t^2 \Rightarrow 5t^2 - 5t - 30 = 0 \Rightarrow t^2 - t - 6 = 0$. Factorizando: $(t-3)(t+2)=0$. La soluciÃ³n positiva es $t=3s$.",
        difficulty: 'hard',
        topic: "Vertical"
    },

    // ------------------------------------------------------------------------------------
    // TEMA: MOVIMIENTO CIRCULAR UNIFORME (MCU)
    // ------------------------------------------------------------------------------------
    // --- Dificultad: FÃ¡cil ---
    {
        question: "En un Movimiento Circular Uniforme (MCU), Â¿quÃ© magnitud permanece constante?",
        options: ["La velocidad vectorial", "La aceleraciÃ³n vectorial", "La rapidez (mÃ³dulo de la velocidad)", "La fuerza centrÃ­peta"],
        answer: 2,
        explanation: "En el MCU, la rapidez (el valor numÃ©rico de la velocidad) es constante. Sin embargo, la direcciÃ³n del vector velocidad cambia continuamente, por lo que la velocidad vectorial no es constante.",
        difficulty: 'easy',
        topic: "MCU"
    },
    {
        question: "La aceleraciÃ³n en un MCU se denomina:",
        options: ["AceleraciÃ³n tangencial", "AceleraciÃ³n angular", "AceleraciÃ³n centrÃ­peta (o normal)", "AceleraciÃ³n gravitatoria"],
        answer: 2,
        explanation: "En un MCU, existe una aceleraciÃ³n dirigida hacia el centro de la trayectoria circular, llamada aceleraciÃ³n centrÃ­peta o normal. Es responsable del cambio en la direcciÃ³n de la velocidad.",
        difficulty: 'easy',
        topic: "MCU"
    },
    {
        question: "El periodo (T) en un MCU es:",
        options: ["El nÃºmero de vueltas por segundo", "El tiempo que tarda en dar una vuelta completa", "La velocidad angular", "El radio de la trayectoria"],
        answer: 1,
        explanation: "El periodo es el tiempo empleado por el mÃ³vil en completar una revoluciÃ³n o vuelta completa.",
        difficulty: 'easy',
        topic: "MCU"
    },
    {
        question: "La frecuencia (f) en un MCU se define como:",
        options: ["El tiempo por vuelta", "El inverso del periodo ($1/T$)", "La velocidad lineal", "El Ã¡ngulo barrido por unidad de tiempo"],
        answer: 1,
        explanation: "La frecuencia es el nÃºmero de vueltas o revoluciones completadas por unidad de tiempo. Es la inversa del periodo: $f = 1/T$.",
        difficulty: 'easy',
        topic: "MCU"
    },
    // --- Dificultad: Medio ---
    {
        question: "Un objeto en MCU tiene una rapidez de $10 m/s$ en una trayectoria circular de radio $5 m$. Â¿CuÃ¡l es su aceleraciÃ³n centrÃ­peta $a_c$?",
        options: ["$2 m/s^2$", "$5 m/s^2$", "$10 m/s^2$", "$20 m/s^2$"],
        answer: 3,
        explanation: "La aceleraciÃ³n centrÃ­peta se calcula como $a_c = v^2/r$, donde $v$ es la rapidez y $r$ es el radio. $a_c = (10 m/s)^2 / (5 m) = 100 m^2/s^2 / 5 m = 20 m/s^2$.",
        difficulty: 'medium',
        topic: "MCU"
    },
    {
        question: "Un disco gira con MCU completando 5 revoluciones en 10 segundos. Â¿CuÃ¡l es su periodo T?",
        options: ["0.5 s", "2 s", "5 s", "10 s"],
        answer: 1,
        explanation: "Si da 5 revoluciones en 10 segundos, el tiempo para 1 revoluciÃ³n (periodo) es $T = \text{tiempo total} / \text{nÃºmero de vueltas} = 10 s / 5 \text{ rev} = 2 s/\text{rev}$.",
        difficulty: 'medium',
        topic: "MCU"
    },
    {
        question: "Para el disco del problema anterior (5 rev en 10 s), Â¿cuÃ¡l es su frecuencia f?",
        options: ["0.5 Hz", "2 Hz", "5 Hz", "0.2 Hz"],
        answer: 0,
        explanation: "Frecuencia $f = \text{nÃºmero de vueltas} / \text{tiempo total} = 5 \text{ rev} / 10 s = 0.5 \text{ rev/s} = 0.5 \text{ Hz}$. TambiÃ©n $f = 1/T = 1/(2s) = 0.5 Hz$.",
        difficulty: 'medium',
        topic: "MCU"
    },
    {
        question: "La velocidad angular ($\omega$) se relaciona con la velocidad lineal ($v$) y el radio ($r$) mediante:",
        options: ["$v = \omega / r$", "$\omega = v / r$", "$r = v \omega$", "$v = \omega^2 r$"],
        answer: 1,
        explanation: "La relaciÃ³n es $v = \omega r$. Por lo tanto, $\omega = v/r$. La velocidad angular se mide en radianes por segundo (rad/s).",
        difficulty: 'medium',
        topic: "MCU"
    },
    // --- Dificultad: DifÃ­cil ---
    {
        question: "Un coche toma una curva circular de $50 m$ de radio con una rapidez constante de $10 m/s$. Si la masa del coche es $1000 kg$, Â¿cuÃ¡l es la magnitud de la fuerza centrÃ­peta que actÃºa sobre Ã©l?",
        options: ["1000 N", "2000 N", "4000 N", "500 N"],
        answer: 1,
        explanation: "Primero calculamos la aceleraciÃ³n centrÃ­peta: $a_c = v^2/r = (10 m/s)^2 / (50 m) = 100/50 = 2 m/s^2$. Luego, la fuerza centrÃ­peta es $F_c = m \cdot a_c = (1000 kg)(2 m/s^2) = 2000 N$.",
        difficulty: 'hard',
        topic: "MCU"
    },
    {
        question: "Un punto en el borde de un disco de $0.5 m$ de radio gira con una velocidad angular de $4\pi \text{ rad/s}$. Â¿CuÃ¡l es su velocidad lineal?",
        options: ["$\pi m/s$", "$2\pi m/s$", "$4\pi m/s$", "$8\pi m/s$"],
        answer: 1,
        explanation: "La velocidad lineal $v = \omega r = (4\pi \text{ rad/s})(0.5 m) = 2\pi m/s$.",
        difficulty: 'hard',
        topic: "MCU"
    },
    {
        question: "Una partÃ­cula se mueve en un cÃ­rculo con un periodo de $0.25 s$. Â¿CuÃ¡l es su frecuencia angular (velocidad angular $\omega$)?",
        options: ["$2\pi \text{ rad/s}$", "$4\pi \text{ rad/s}$", "$8\pi \text{ rad/s}$", "$\pi \text{ rad/s}$"],
        answer: 2,
        explanation: "La velocidad angular $\omega = 2\pi f$. La frecuencia $f = 1/T = 1/(0.25s) = 4 Hz$. Entonces, $\omega = 2\pi (4 Hz) = 8\pi \text{ rad/s}$.",
        difficulty: 'hard',
        topic: "MCU"
    },
    {
        question: "Si la velocidad angular de un objeto en MCU se duplica y el radio de su trayectoria se mantiene constante, Â¿cÃ³mo cambia su aceleraciÃ³n centrÃ­peta?",
        options: ["Se duplica", "Se cuadruplica", "Se reduce a la mitad", "No cambia"],
        answer: 1,
        explanation: "La aceleraciÃ³n centrÃ­peta es $a_c = \omega^2 r$. Si $\omega$ se duplica a $2\omega$, la nueva aceleraciÃ³n $a_c' = (2\omega)^2 r = 4\omega^2 r = 4a_c$. Se cuadruplica.",
        difficulty: 'hard',
        topic: "MCU"
    },

    // ------------------------------------------------------------------------------------
    // TEMA: MOVIMIENTO PARABÃ“LICO
    // ------------------------------------------------------------------------------------
    // --- Dificultad: FÃ¡cil ---
    {
        question: "El movimiento parabÃ³lico es la composiciÃ³n de dos movimientos independientes: uno horizontal __________ y uno vertical __________.",
        options: ["MRU, MRUA (caÃ­da libre)", "MRUA, MRU", "MRU, MRU", "MRUA, MRUA"],
        answer: 0,
        explanation: "En ausencia de resistencia del aire, el movimiento horizontal es un MRU (velocidad horizontal constante) y el movimiento vertical es un MRUA (aceleraciÃ³n constante debida a la gravedad).",
        difficulty: 'easy',
        topic: "ParabÃ³lico"
    },
    {
        question: "En un lanzamiento parabÃ³lico, la componente horizontal de la velocidad (despreciando la resistencia del aire):",
        options: ["Aumenta con el tiempo", "Disminuye con el tiempo", "Permanece constante", "Es cero en el punto mÃ¡s alto"],
        answer: 2,
        explanation: "Como no hay fuerzas horizontales actuando (se desprecia la resistencia del aire), la aceleraciÃ³n horizontal es cero, y por lo tanto, la componente horizontal de la velocidad ($v_x$) es constante durante todo el vuelo.",
        difficulty: 'easy',
        topic: "ParabÃ³lico"
    },
    {
        question: "En el punto mÃ¡s alto de una trayectoria parabÃ³lica, la componente vertical de la velocidad es:",
        options: ["MÃ¡xima", "MÃ­nima (pero no cero)", "Cero", "Igual a la componente horizontal"],
        answer: 2,
        explanation: "En el vÃ©rtice de la parÃ¡bola (altura mÃ¡xima), el proyectil deja de subir verticalmente y comienza a bajar. En ese instante, su velocidad vertical $v_y = 0$.",
        difficulty: 'easy',
        topic: "ParabÃ³lico"
    },
    {
        question: "El Ã¡ngulo de lanzamiento que produce el mayor alcance horizontal para una velocidad inicial dada (en ausencia de resistencia del aire) es:",
        options: ["30Â°", "45Â°", "60Â°", "90Â° (lanzamiento vertical)"],
        answer: 1,
        explanation: "Para una velocidad inicial fija y despreciando la resistencia del aire, el alcance horizontal mÃ¡ximo se logra con un Ã¡ngulo de lanzamiento de 45Â° respecto a la horizontal.",
        difficulty: 'easy',
        topic: "ParabÃ³lico"
    },
    // --- Dificultad: Medio ---
    {
        question: "Un proyectil se lanza con una velocidad inicial $v_0 = 20 m/s$ y un Ã¡ngulo de $30^\circ$ con la horizontal. Â¿CuÃ¡l es la componente horizontal inicial de la velocidad $v_{0x}$? (sen 30Â°=0.5, cos 30Â°â‰ˆ0.866)",
        options: ["$10 m/s$", "$17.32 m/s$", "$20 m/s$", "$0 m/s$"],
        answer: 1,
        explanation: "La componente horizontal inicial es $v_{0x} = v_0 \cos\theta = (20 m/s) \cos(30^\circ) \approx (20 m/s)(0.866) \approx 17.32 m/s$.",
        difficulty: 'medium',
        topic: "ParabÃ³lico"
    },
    {
        question: "Para el proyectil del problema anterior ($v_0 = 20 m/s$, $\theta = 30^\circ$), Â¿cuÃ¡l es la componente vertical inicial de la velocidad $v_{0y}$?",
        options: ["$10 m/s$", "$17.32 m/s$", "$20 m/s$", "$0 m/s$"],
        answer: 0,
        explanation: "La componente vertical inicial es $v_{0y} = v_0 \sin\theta = (20 m/s) \sin(30^\circ) = (20 m/s)(0.5) = 10 m/s$.",
        difficulty: 'medium',
        topic: "ParabÃ³lico"
    },
    {
        question: "Un balÃ³n es pateado con un Ã¡ngulo de $60^\circ$ y alcanza una altura mÃ¡xima de $15 m$. Â¿CuÃ¡l fue la componente vertical inicial de su velocidad? (Usar $g \approx 10 m/s^2$)",
        options: ["$10\sqrt{3} m/s$", "$15 m/s$", "$10 m/s$", "$5\sqrt{6} m/s$"],
        answer: 0, // vf_y^2 = v0_y^2 - 2gh => 0 = v0_y^2 - 2*10*15 => v0_y^2 = 300 => v0_y = sqrt(300) = 10*sqrt(3)
        explanation: "En la altura mÃ¡xima $H$, $v_{fy}^2 = v_{0y}^2 - 2gH$. Como $v_{fy}=0$, tenemos $0 = v_{0y}^2 - 2gH \Rightarrow v_{0y}^2 = 2gH$. $v_{0y} = \sqrt{2gH} = \sqrt{2 \cdot 10 m/s^2 \cdot 15 m} = \sqrt{300} m/s = 10\sqrt{3} m/s \approx 17.32 m/s$.",
        difficulty: 'medium',
        topic: "ParabÃ³lico"
    },
    {
        question: "La aceleraciÃ³n de un proyectil en movimiento parabÃ³lico (despreciando resistencia del aire) es:",
        options: ["Cero en todo momento", "Constante y horizontal", "Constante y vertical hacia abajo (g)", "Variable"],
        answer: 2,
        explanation: "Una vez lanzado, la Ãºnica fuerza significativa que actÃºa sobre el proyectil (si se desprecia la resistencia del aire) es la gravedad, que produce una aceleraciÃ³n constante $g$ dirigida verticalmente hacia abajo.",
        difficulty: 'medium',
        topic: "ParabÃ³lico"
    },
    // --- Dificultad: DifÃ­cil ---
    {
        question: "Un caÃ±Ã³n dispara un proyectil con una velocidad inicial de $100 m/s$ y un Ã¡ngulo de $53^\circ$ sobre la horizontal. Â¿CuÃ¡nto tiempo tarda el proyectil en alcanzar su altura mÃ¡xima? (sen 53Â°â‰ˆ0.8, cos 53Â°â‰ˆ0.6, $g \approx 10 m/s^2$)",
        options: ["6 s", "8 s", "10 s", "12 s"],
        answer: 1,
        explanation: "La componente vertical inicial es $v_{0y} = v_0 \sin\theta = 100 m/s \cdot 0.8 = 80 m/s$. En la altura mÃ¡xima, $v_{fy}=0$. Usamos $v_{fy} = v_{0y} - gt \Rightarrow 0 = 80 m/s - (10 m/s^2)t \Rightarrow 10t = 80 \Rightarrow t = 8 s$.",
        difficulty: 'hard',
        topic: "ParabÃ³lico"
    },
    {
        question: "Para el proyectil del problema anterior ($v_0=100 m/s, \theta=53^\circ, t_{\text{subida}}=8s$), Â¿cuÃ¡l es el tiempo total de vuelo hasta que regresa al mismo nivel de lanzamiento?",
        options: ["8 s", "12 s", "16 s", "20 s"],
        answer: 2,
        explanation: "En ausencia de resistencia del aire y si el punto de llegada estÃ¡ al mismo nivel que el de partida, el tiempo de subida es igual al tiempo de bajada. Tiempo total de vuelo $T = 2 \times t_{\text{subida}} = 2 \times 8 s = 16 s$.",
        difficulty: 'hard',
        topic: "ParabÃ³lico"
    },
    {
        question: "Un bombardero vuela horizontalmente a una altura de $500 m$ con una velocidad de $100 m/s$. Suelta una bomba. Â¿QuÃ© distancia horizontal recorre la bomba antes de impactar el suelo? (Despreciar resistencia del aire, $g \approx 10 m/s^2$)",
        options: ["500 m", "1000 m", "1500 m", "2000 m"],
        answer: 1,
        explanation: "Primero calculamos el tiempo de caÃ­da vertical: $h = (1/2)gt^2$ (ya que $v_{0y}=0$). $500 m = (1/2)(10 m/s^2)t^2 \Rightarrow 500 = 5t^2 \Rightarrow t^2 = 100 \Rightarrow t = 10 s$. Durante este tiempo, la bomba se mueve horizontalmente con $v_x = 100 m/s$. Alcance $X = v_x \cdot t = (100 m/s)(10 s) = 1000 m$.",
        difficulty: 'hard',
        topic: "ParabÃ³lico"
    },
    {
        question: "Se lanza un proyectil con una velocidad inicial tal que su alcance horizontal mÃ¡ximo es de $160 m$. Â¿CuÃ¡l fue la altura mÃ¡xima alcanzada en ese lanzamiento? (Recuerda que el alcance mÃ¡ximo es para $\theta=45^\circ$ y $H_{max} = R_{max}/4$ para ese Ã¡ngulo)",
        options: ["20 m", "40 m", "80 m", "160 m"],
        answer: 1,
        explanation: "Para un Ã¡ngulo de $45^\circ$, que da el alcance mÃ¡ximo ($R_{max}$), la altura mÃ¡xima ($H_{max}$) estÃ¡ relacionada por $H_{max} = R_{max} / 4$. Entonces, $H_{max} = 160 m / 4 = 40 m$.",
        difficulty: 'hard',
        topic: "ParabÃ³lico"
    }
];
        const physicsFacts = [
            "El sonido no viaja en el vacÃ­o. ğŸŒŒ",
            "La luz del Sol â˜€ï¸ tarda ~8 min 20 s en llegar a la Tierra ğŸŒ.",
            "Un agujero negro âš« tiene gravedad tan fuerte que ni la luz escapa.",
            "La Torre Eiffel ğŸ—¼ es mÃ¡s alta en verano por expansiÃ³n tÃ©rmica.",
            "Una cucharadita de estrella de neutrones â­ pesa miles de millones de toneladas.",
            "El efecto invernadero natural mantiene la Tierra habitable. Greenhouse effect! â™¨ï¸",
            "Las auroras boreales/australes âœ¨ son causadas por partÃ­culas solares.",
            "La fisiÃ³n nuclear divide Ã¡tomos; la fusiÃ³n nuclear los une (como en el Sol). âš›ï¸",
            "La antimateria existe y se aniquila con la materia. ğŸ’¥",
            "El universo se expande aceleradamente (debido a la energÃ­a oscura). ğŸŒ "
        ];

        function getRandomFact() { return physicsFacts[Math.floor(Math.random() * physicsFacts.length)]; }

        function getQuestion() {
            const availableQuestions = physicsQuestions.filter(q =>
                (currentDifficulty === 'easy' && q.difficulty === 'easy') ||
                (currentDifficulty === 'medium' && (q.difficulty === 'easy' || q.difficulty === 'medium')) ||
                (currentDifficulty === 'hard')
            );

            let questionPool = availableQuestions;
            if (availableQuestions.length > 1 && currentQuestionData) {
                 questionPool = availableQuestions.filter(q => q.question !== currentQuestionData.question);
                 if (questionPool.length === 0) questionPool = availableQuestions;
            }

            if (questionPool.length === 0) {
                console.warn("No hay preguntas disponibles para esta dificultad, usando cualquiera.");
                questionPool = physicsQuestions;
                if (questionPool.length === 0) return null;
            }

            const randomIndex = Math.floor(Math.random() * questionPool.length);
            return questionPool[randomIndex];
        }

        function checkLevelCompletion() {
             return questionsAnsweredThisLevel >= questionsTarget;
        }

        function askQuestion(source = 'auto') {
             if (gameOver || isModalVisible() || currentQuestionData !== null) {
                 console.warn("Intento de abrir pregunta â“ mientras otra estÃ¡ activa, juego terminado o modal visible.");
                 if(!questionModal.classList.contains('visible')) {
                    if (gamePaused && !questionModal.classList.contains('visible')) return;
                 }
             }

             gamePaused = true;
             playSound('questionAppear');
             currentQuestionData = getQuestion();
             if (!currentQuestionData) {
                 console.error("No se pudo obtener una pregunta. ğŸ˜­");
                 gamePaused = false;
                 return;
             }

             if (source === 'icon') {
                 questionsAnsweredThisLevel++;
             }
             totalQuestionsAnsweredGame++;

             const questionTextElement = document.getElementById('question-text');
             const questionCounterElement = document.getElementById('question-counter-modal');

             if (questionTextElement) questionTextElement.innerHTML = currentQuestionData.question;
             if (questionCounterElement) questionCounterElement.textContent = `Pregunta Nivel: ${questionsAnsweredThisLevel}/${questionsTarget}`;

             const optionsContainer = document.getElementById('options-container');
             if (optionsContainer) {
                 optionsContainer.innerHTML = '';
                 currentQuestionData.options.forEach((option, index) => {
                     const button = document.createElement('button');
                     button.innerHTML = option;
                     button.classList.add('option-btn');
                     button.onclick = () => handleAnswer(index);
                     optionsContainer.appendChild(button);
                 });
             }

             const feedbackContainer = document.getElementById('feedback-container');
             const feedbackContent = document.getElementById('feedback-content');
             const acceptFeedbackBtn = document.getElementById('accept-feedback-btn');
             if (feedbackContainer) feedbackContainer.style.display = 'none';
             if (feedbackContent) feedbackContent.innerHTML = '';
             if (acceptFeedbackBtn) acceptFeedbackBtn.style.display = 'none';

             showModal(questionModal);
             updateUI();

             if (typeof MathJax !== "undefined" && MathJax.typesetPromise) {
                MathJax.typesetPromise([questionModal]).catch(function (err) {
                    console.error('Error al renderizar MathJax en pregunta:', err);
                });
             }
        }

        function handleAnswer(selectedIndex) {
             if (!currentQuestionData) return;
             const correctIndex = currentQuestionData.answer;
             const isCorrect = selectedIndex === correctIndex;
             const feedbackContainer = document.getElementById('feedback-container');
             const feedbackContent = document.getElementById('feedback-content');
             const optionsButtons = document.querySelectorAll('#options-container .option-btn');

             optionsButtons.forEach((button, index) => {
                 button.disabled = true;
                 if (index === correctIndex) button.classList.add('correct-option');
                 else if (index === selectedIndex) button.classList.add('incorrect-option');
             });

             feedbackContent.innerHTML = '';
             const feedbackTitle = document.createElement('strong');
             const explanationP = document.createElement('p');
             explanationP.classList.add('explanation-text');
             explanationP.innerHTML = currentQuestionData.explanation || '';

             if (isCorrect) {
                 playSound('correctAnswer');
                 feedbackContainer.className = 'feedback correct';
                 feedbackTitle.textContent = "âœ… Â¡Correcto! ğŸ‰";
                 score += (50 + (level-1)*10) * (currentDifficulty === 'hard' ? 2 : (currentDifficulty === 'medium' ? 1.5 : 1));
                 questionsCorrectThisLevel++;
                 totalQuestionsCorrectGame++;
             } else {
                 playSound('incorrectAnswer');
                 feedbackContainer.className = 'feedback incorrect';
                 feedbackTitle.textContent = "âŒ Incorrecto... ğŸ˜¥";
                 const correctAnswerLabel = document.createElement('p');
                 correctAnswerLabel.innerHTML = `<span class="correct-answer-label">Respuesta correcta:</span> ${currentQuestionData.options[correctIndex]}`;
                 feedbackContent.appendChild(correctAnswerLabel);
             }

             feedbackContent.prepend(feedbackTitle);
             feedbackContent.appendChild(explanationP);
             feedbackContainer.style.display = 'block';

             const acceptBtn = document.getElementById('accept-feedback-btn');
             if (acceptBtn) {
                 acceptBtn.style.display = 'block';
                 acceptBtn.onclick = closeQuestionModal;
             }
             updateUI();

             if (typeof MathJax !== "undefined" && MathJax.typesetPromise) {
                MathJax.typesetPromise([feedbackContainer]).catch(function (err) {
                    console.error('Error al renderizar MathJax en feedback:', err);
                });
             }
        }

        function closeQuestionModal() {
             hideModal(questionModal);
             currentQuestionData = null;
             const questionsGoalReached = checkLevelCompletion();

             if (questionsGoalReached && invaderGrid && invaderGrid.invaders.length === 0) {
                 console.log("ğŸ¯ Objetivo de preguntas alcanzado y oleada limpia. Â¡Terminando nivel! ğŸ‰");
                 triggerLevelComplete();
             } else {
                 gamePaused = false;
                 lastTime = performance.now();
                 console.log("Pregunta cerrada, juego reanudado. â–¶ï¸");
             }
             updateUI();
        }

        function getRatingStarsHTML(rating) {
            let starsHTML = '';
            for (let i = 1; i <= 5; i++) {
                starsHTML += `<span class="${i <= rating ? 'star-filled' : 'star-empty'}">â­</span>`;
            }
            return starsHTML;
        }

        // --- Funciones de Fin de Juego / Nivel ---
        function triggerGameOver(message) {
            if (gameOver) return;
            console.log("â˜ ï¸ Game Over Activado:", message);
            gameOver = true; gameRunning = false; gamePaused = true;
            playSound('explosion');

            const scoreFactor = Math.min(5, Math.floor(score / (800 * level + 1)));
            const questionAccuracyFactor = totalQuestionsAnsweredGame > 0
                ? Math.min(5, Math.round((totalQuestionsCorrectGame / totalQuestionsAnsweredGame) * 5))
                : 2;
            const levelFactor = Math.min(5, Math.floor(level / 2));
            const finalRating = Math.max(0, Math.min(5, Math.round(
                scoreFactor * 0.3 + questionAccuracyFactor * 0.5 + levelFactor * 0.2
            )));

            document.getElementById('final-message').textContent = message;
            document.getElementById('final-score').textContent = score;
            document.getElementById('final-level').textContent = level;
            document.getElementById('final-difficulty').textContent = capitalizeFirst(currentDifficulty);
            document.getElementById('final-questions-correct-gameover').textContent = totalQuestionsCorrectGame;
            document.getElementById('final-questions-answered-gameover').textContent = totalQuestionsAnsweredGame;
            document.getElementById('final-rating-gameover-text').textContent = `${finalRating}/5`;
            document.getElementById('final-rating-gameover-stars').innerHTML = getRatingStarsHTML(finalRating);
            document.getElementById('fact-text-gameover').textContent = getRandomFact();

            const highScore = getHighScore(currentDifficulty);
            const highScoreDisplay = document.getElementById('high-score-display');
            document.getElementById('high-score-difficulty-gameover').textContent = capitalizeFirst(currentDifficulty);
            document.getElementById('high-score-gameover').textContent = highScore;
            if (score > highScore) {
                saveHighScore(currentDifficulty, score);
                highScoreDisplay.innerHTML = `ğŸ† Mejor Score (${capitalizeFirst(currentDifficulty)}): ${score} <span style='color: var(--accent-green);'>(Â¡NUEVO!)</span>`;
            } else {
                 highScoreDisplay.innerHTML = `ğŸ† Mejor Score (${capitalizeFirst(currentDifficulty)}): ${highScore}`;
            }

            showModal(gameOverModal);
            pauseBtn.disabled = true;
            restartBtnGlobal.disabled = false;
        }

        function triggerLevelComplete() {
            if (gameOver || (isModalVisible() && !questionModal.classList.contains('visible'))) return;
            console.log(`ğŸ‰ Nivel ${level} completado!`);
            gamePaused = true;
            playSound('correctAnswer');

            const questionAccuracyNivel = questionsAnsweredThisLevel > 0
                ? (questionsCorrectThisLevel / questionsAnsweredThisLevel)
                : 1;
            const livesBonusFactor = Math.min(5, lives * 1.2);
            const accuracyFactorNivel = Math.min(5, questionAccuracyNivel * 5);
            const ratingNivel = Math.max(0, Math.min(5, Math.round(
                accuracyFactorNivel * 0.7 + livesBonusFactor * 0.3
            )));

            document.getElementById('complete-message').textContent = `Â¡FantÃ¡stico! Has superado el Nivel ${level} ğŸŒŸ.`;
            document.getElementById('complete-score').textContent = score;
            document.getElementById('complete-level').textContent = level;
            document.getElementById('complete-difficulty').textContent = capitalizeFirst(currentDifficulty);
            document.getElementById('complete-questions-correct').textContent = questionsCorrectThisLevel;
            document.getElementById('complete-questions-answered').textContent = questionsAnsweredThisLevel;
            document.getElementById('complete-rating-text').textContent = `${ratingNivel}/5`;
            document.getElementById('complete-rating-stars').innerHTML = getRatingStarsHTML(ratingNivel);
            document.getElementById('fact-text-complete').textContent = getRandomFact();

            const highScore = getHighScore(currentDifficulty);
            const highScoreDisplayComplete = document.getElementById('high-score-display-complete');
            document.getElementById('high-score-difficulty-complete').textContent = capitalizeFirst(currentDifficulty);
            document.getElementById('high-score-complete').textContent = highScore;
             if (score > highScore) {
                saveHighScore(currentDifficulty, score);
                highScoreDisplayComplete.innerHTML = `ğŸ† Mejor Score (${capitalizeFirst(currentDifficulty)}): ${score} <span style='color: var(--accent-green);'>(Â¡NUEVO!)</span>`;
            } else {
                 highScoreDisplayComplete.innerHTML = `ğŸ† Mejor Score (${capitalizeFirst(currentDifficulty)}): ${highScore}`;
            }

            showModal(levelCompleteModal);
            pauseBtn.disabled = true;
        }

        function nextLevel() {
            hideModal(levelCompleteModal);
            level++; wave = 1;
            questionsAnsweredThisLevel = 0; questionsCorrectThisLevel = 0;
            gamePaused = false;
            setupLevel();
            console.log(`ğŸš€ Iniciando Nivel ${level}`);
            lastTime = performance.now();
            pauseBtn.disabled = false;
            updateUI();
        }

        // --- Funciones Auxiliares ---
        function showModal(modalElement) { modalElement.classList.add('visible'); }
        function hideModal(modalElement) { modalElement.classList.remove('visible'); }
        function getHighScore(difficulty) { return parseInt(localStorage.getItem(`invadersFisicaHighScore_${difficulty}`) || '0'); }
        function saveHighScore(difficulty, newScore) { try { localStorage.setItem(`invadersFisicaHighScore_${difficulty}`, newScore.toString()); } catch (e) { console.error("Error al guardar high score:", e); } }
        function capitalizeFirst(text) { if (!text) return ''; return text.charAt(0).toUpperCase() + text.slice(1); }

        function resizeCanvas() {
            const container = document.querySelector('.container');
            if (!container) return;
            const containerStyles = getComputedStyle(container);
            const containerWidth = container.clientWidth - parseInt(containerStyles.paddingLeft) - parseInt(containerStyles.paddingRight);
            const aspectRatio = 4 / 3;
            const maxWidth = 700;

            let newWidth = Math.min(containerWidth, maxWidth);
            let newHeight = newWidth / aspectRatio;

            let heightToSubtract = 60; // Reducido el margen base estimado
            try {
                 heightToSubtract += document.getElementById('global-controls')?.offsetHeight || 0;
                 heightToSubtract += document.getElementById('ui-bar')?.offsetHeight || 0;
                 const mc = document.getElementById('mobile-controls');
                 if (mc && getComputedStyle(mc).display !== 'none') {
                    heightToSubtract += mc.offsetHeight || 0;
                 }
                 heightToSubtract += document.querySelector('footer')?.offsetHeight || 0;
            } catch (e) { console.warn("Error obteniendo altura de UI para resize:", e); }

            const availableHeight = window.innerHeight - heightToSubtract;

            if (newHeight > availableHeight && availableHeight > 100) {
                newHeight = availableHeight;
                newWidth = newHeight * aspectRatio;
            }
            newWidth = Math.min(newWidth, containerWidth);

            canvas.width = Math.max(200, Math.floor(newWidth));
            canvas.height = Math.max(150, Math.floor(newHeight));

            if (gameRunning && player) {
                player.baseWidth = canvas.width * 0.055;
                player.baseHeight = player.baseWidth * 0.85;
                player.width = player.baseWidth; player.height = player.baseHeight;
                player.x = Math.max(0, Math.min(player.x, canvas.width - player.width));
                player.y = canvas.height - player.height - 20;
            }
        }

        function isModalVisible() {
            return Array.from(document.querySelectorAll('.modal-overlay')).some(modal => modal.classList.contains('visible'));
        }

        // --- Event Listeners ---
        window.addEventListener('keydown', (e) => {
            if (isModalVisible() && e.key !== 'Escape') {
                if(document.getElementById('question-modal').classList.contains('visible')) {
                   // LÃ³gica especÃ­fica para modal de pregunta si es necesario
                } else {
                    return;
                }
            }
            keys[e.key] = true;
            if (gameRunning && [' ', 'ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                e.preventDefault();
            }
            if (gameRunning && !isModalVisible()) {
                if ((e.key === 'p' || e.key === 'P') && !pauseBtn.disabled) togglePause();
                if ((e.key === 'r' || e.key === 'R') && !restartBtnGlobal.disabled) restartGame();
                if ((e.key === 'm' || e.key === 'M')) toggleMute();
            }
        });
        window.addEventListener('keyup', (e) => { keys[e.key] = false; });

        function handleTouchStart(e) {
             if (isModalVisible()) return;
             e.preventDefault();
             const target = e.target.closest('.control-btn');
             if (!target) return;

             const buttonId = target.id.split('-')[0];
             const keyName = 'touch' + capitalizeFirst(buttonId);
             keys[keyName] = true;
             target.classList.add('active-touch');

            if (soundsEnabled && typeof Tone !== 'undefined' && Tone.context.state === 'suspended') {
                Tone.start().then(() => {
                    console.log("ğŸ”Š AudioContext iniciado/reanudado por interacciÃ³n tÃ¡ctil.");
                    if (!audioInitialized) initializeSounds();
                }).catch(err => console.error("Error iniciando/reanudando AudioContext:", err));
            }
        }
        function handleTouchEnd(e) {
             [leftBtn, rightBtn, shootBtn].forEach(btn => {
                 const buttonId = btn.id.split('-')[0];
                 const keyName = 'touch' + capitalizeFirst(buttonId);
                 if (keys[keyName]) { keys[keyName] = false; btn.classList.remove('active-touch'); }
             });
        }
        [leftBtn, rightBtn, shootBtn].forEach(btn => {
            btn.addEventListener('touchstart', handleTouchStart, { passive: false });
        });
        document.addEventListener('touchend', handleTouchEnd, { passive: false });
        document.addEventListener('touchcancel', handleTouchEnd, { passive: false });

        pauseBtn.addEventListener('click', togglePause);
        restartBtnGlobal.addEventListener('click', restartGame);

        document.querySelectorAll('.difficulty-btn').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.difficulty-btn').forEach(btn => btn.classList.remove('selected'));
                button.classList.add('selected');
                currentDifficulty = button.dataset.difficulty;
                console.log(`Dificultad seleccionada: ${currentDifficulty}`);
            });
        });

        document.getElementById('start-button').addEventListener('click', () => {
            const selectedDifficulty = document.querySelector('.difficulty-btn.selected').dataset.difficulty;
            if (typeof Tone !== 'undefined') {
                Tone.start().then(() => {
                    console.log("ğŸ”Š AudioContext iniciado por botÃ³n de Start.");
                    initializeSounds();
                    initGame(selectedDifficulty);
                }).catch(e => {
                    console.warn("No se pudo iniciar AudioContext, iniciando sin sonido:", e);
                    soundsEnabled = false; muteBtn.textContent = 'ğŸ”‡ Sonido OFF';
                    initGame(selectedDifficulty);
                });
            } else {
                initGame(selectedDifficulty);
            }
        });

        document.getElementById('help-button').addEventListener('click', () => showModal(helpModal));
        document.getElementById('close-help-button').addEventListener('click', () => hideModal(helpModal));
        document.getElementById('restart-button-gameover').addEventListener('click', restartGame);
        document.getElementById('next-level-button').addEventListener('click', nextLevel);
        document.getElementById('restart-button-complete').addEventListener('click', restartGame);

        window.addEventListener('resize', resizeCanvas);
        window.addEventListener('load', () => {
            resizeCanvas(); // Primer ajuste al cargar
            // Ajuste adicional despuÃ©s de un breve retraso para asegurar que todo estÃ© renderizado
            setTimeout(resizeCanvas, 100);
            console.log("ğŸ® PÃ¡gina cargada y lista. Â¡A jugar! ");
        });
        // resizeCanvas(); // Llamada inicial aquÃ­ tambiÃ©n puede ser Ãºtil
    </script>
</body>
</html>